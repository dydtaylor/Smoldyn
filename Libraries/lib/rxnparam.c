/* File rxnparam.c, written by Steve Andrews, 2003.
This code is in the public domain.  It is not copyrighted and may not be
copyrighted.

This file calculates reaction rates for a stochastic spatial numerical method,
as described in the research paper "Stochastic Simulation of Chemical Reactions
with Spatial Resolution and Single Molecule Detail" written by Steven S. Andrews
and Dennis Bray, which was published in Physical Biology in 2004.  The code
here is written entirely in ANSII C.

History: Started 3/02, converted to a separate file 5/31/03.
  Several updates made and documentation written 4/08.   */


#include <stdio.h>
#include <stdlib.h>
#include <float.h>
#include <math.h>
#include "rxnparam.h"

#define PI 3.14159265358979323846
#define SQRT2PI 2.50662827462

double rxnparam_erfccD(double x);


/******************************************************************************/
/****************************  UTILITY FUNCTIONS  *****************************/
/******************************************************************************/

/* modelrxnrate */
double modelrxnrate(double a,double b,double difc,double chi) {
	double rate;

	if(b<0) rate=4*PI*difc*a*chi;
	else if(b<=a) rate=-1;
	else rate=4*PI*difc*a*chi/(1.0-a/b);
	return rate; }


/******************************************************************************/
/***  LOOK-UP FUNCTIONS FOR REACTION RATES AND BINDING AND UNBINDING RADII  ***/
/******************************************************************************/

/* numrxnrate calculates the bimolecular reaction rate for the simulation
algorithm, based on the rms step length in step, the binding radius in a, and
the unbinding radius in b.  It uses cubic polynomial interpolation on previously
computed data, with interpolation both on the reduced step length (step/a) and
on the reduced unbinding radius (b/a).  Enter a negative value of b for
irreversible reactions.  If the input parameters result in reduced values that
are off the edge of the tabulated data, analytical results are used where
possible.  If there are no analytical results, the data are extrapolated.
Variable components: s is step, i is irreversible, r is reversible with b>a, b
is reversible with b<a, y is a rate.  The returned value is the reaction rate
times the time step delta_t.  In other words, this rate constant is per time
step, not per time unit; it has units of length cubed.  */
double numrxnrate(double step,double a,double b) {
	static const double yi[]={				// 600 pts, eps=1e-5, up&down, error<2.4%
		4.188584,4.188381,4.187971,4.187141,4.185479,4.182243,4.1761835,4.1652925,
		4.146168,4.112737,4.054173,3.95406,3.7899875,3.536844,3.178271,2.7239775,
		2.2178055,1.7220855,1.2875175,0.936562,0.668167,0.470021,0.327102,0.225858,
		0.1551475,0.1061375,0.072355,0.049183,0.0333535,0.022576,0.015257};
	static const double yr[]={				// 500 pts, eps=1e-5, up&down, error<2.2%
		4.188790,4.188790,4.188790,4.188788,4.188785,4.188775,4.188747,4.188665,
		4.188438,4.187836,4.186351,4.182961,4.175522,4.158666,4.119598,4.036667,
		3.883389,3.641076,3.316941,2.945750,2.566064,2.203901,1.872874,1.578674,
		1.322500,1.103003,0.916821,0.759962,0.628537,0.518952,0.428136,
		4.188790,4.188790,4.188789,4.188786,4.188778,4.188756,4.188692,4.188509,
		4.188004,4.186693,4.183529,4.176437,4.160926,4.125854,4.047256,3.889954,
		3.621782,3.237397,2.773578,2.289205,1.831668,1.427492,1.087417,0.811891,
		0.595737,0.430950,0.308026,0.217994,0.152981,0.106569,0.073768,
		4.188790,4.188789,4.188788,4.188783,4.188768,4.188727,4.188608,4.188272,
		4.187364,4.185053,4.179623,4.167651,4.141470,4.082687,3.956817,3.722364,
		3.355690,2.877999,2.353690,1.850847,1.411394,1.050895,0.768036,0.553077,
		0.393496,0.277134,0.193535,0.134203,0.092515,0.063465,0.043358,
		4.188790,4.188789,4.188786,4.188777,4.188753,4.188682,4.188480,4.187919,
		4.186431,4.182757,4.174363,4.156118,4.116203,4.028391,3.851515,3.546916,
		3.110183,2.587884,2.055578,1.574898,1.174608,0.858327,0.617223,0.438159,
		0.307824,0.214440,0.148358,0.102061,0.069885,0.047671,0.032414,
		4.188789,4.188788,4.188783,4.188769,4.188729,4.188614,4.188288,4.187399,
		4.185108,4.179638,4.167499,4.141379,4.084571,3.964576,3.739474,3.381771,
		2.906433,2.372992,1.854444,1.401333,1.032632,0.746509,0.531766,0.374442,
		0.261247,0.180929,0.124557,0.085332,0.058229,0.039604,0.026865,
		4.188789,4.188786,4.188778,4.188756,4.188692,4.188510,4.188002,4.186650,
		4.183288,4.175566,4.158864,4.123229,4.047257,3.896024,3.632545,3.242239,
		2.750962,2.220229,1.717239,1.285681,0.939696,0.674540,0.477621,0.334612,
		0.232460,0.160415,0.110103,0.075242,0.051236,0.034789,0.023565,
		4.188788,4.188784,4.188772,4.188737,4.188637,4.188354,4.187585,4.185607,
		4.180895,4.170490,4.148460,4.102035,4.006907,3.829897,3.541151,3.133335,
		2.635739,2.109597,1.619284,1.204298,0.875185,0.625190,0.440882,0.307818,
		0.213235,0.146800,0.100560,0.068608,0.046655,0.031645,0.021415,
		4.188787,4.188780,4.188761,4.188707,4.188552,4.188124,4.186995,4.184222,
		4.177931,4.164527,4.136619,4.079198,3.967945,3.772932,3.468711,3.050092,
		2.548726,2.026932,1.547039,1.144954,0.828592,0.589866,0.414774,0.288895,
		0.199728,0.137273,0.093903,0.063994,0.043478,0.029467,0.019931,
		4.188785,4.188774,4.188745,4.188661,4.188426,4.187795,4.186203,4.182494,
		4.174471,4.157859,4.123939,4.056910,3.934028,3.727335,3.412145,2.985387,
		2.481620,1.963935,1.492519,1.100533,0.793976,0.563797,0.395615,0.275071,
		0.189896,0.130359,0.089086,0.060661,0.041187,0.027899,0.018863,
		4.188782,4.188766,4.188720,4.188592,4.188244,4.187347,4.185205,4.180486,
		4.170691,4.150875,4.111574,4.037574,3.906673,3.691217,3.367270,2.934386,
		2.429282,1.915212,1.450660,1.066615,0.767733,0.544143,0.381225,0.264724,
		0.182558,0.125209,0.085504,0.058187,0.039490,0.026741,0.018074,
		4.188777,4.188752,4.188683,4.188492,4.187993,4.186777,4.184049,4.178342,
		4.166861,4.144167,4.100756,4.021817,3.884852,3.662169,3.331386,2.893934,
		2.388069,1.877097,1.418051,1.040351,0.747549,0.529083,0.370239,0.256844,
		0.176983,0.121304,0.082791,0.056318,0.038211,0.025871,0.017486,
		4.188770,4.188732,4.188628,4.188352,4.187671,4.186115,4.182830,4.176234,
		4.163261,4.138284,4.092055,4.009206,3.867171,3.638731,3.302580,2.861651,
		2.355385,1.846979,1.392364,1.019841,0.731849,0.517409,0.361743,0.250766,
		0.172684,0.118295,0.080706,0.054883,0.037230,0.025204,0.017035,
		4.188759,4.188702,4.188551,4.188171,4.187294,4.185421,4.181657,4.174292,
		4.160089,4.133434,4.084980,3.998932,3.852801,3.619743,3.279339,2.835771,
		2.329266,1.822929,1.372041,1.003734,0.719559,0.508296,0.355130,0.246037,
		0.169346,0.115966,0.079096,0.053783,0.036482,0.024699,0.016694,
		4.188742,4.188659,4.188449,4.187958,4.186900,4.184765,4.180606,4.172596,
		4.157440,4.129551,4.079183,3.990499,3.841031,3.604270,3.260519,2.814871,
		2.308170,1.803653,1.355971,0.991032,0.709899,0.501150,0.349948,0.242337,
		0.166741,0.114156,0.077855,0.052940,0.035912,0.024316,0.016437,
		4.188719,4.188603,4.188330,4.187736,4.186534,4.184200,4.179711,4.171172,
		4.155254,4.126372,4.074457,3.983648,3.831433,3.591609,3.245083,2.797662,
		2.290945,1.788288,1.343237,0.981003,0.702295,0.495533,0.345879,0.239437,
		0.164709,0.112756,0.076902,0.052295,0.035478,0.024023,0.016239,
		4.188688,4.188536,4.188204,4.187532,4.186227,4.183725,4.178948,4.169962,
		4.153461,4.123737,4.070508,3.977891,3.823388,3.580958,3.232035,2.783281,
		2.277011,1.776032,1.333144,0.973094,0.696303,0.491107,0.342676,0.237173,
		0.163143,0.111689,0.076180,0.051808,0.035151,0.023802,0.016089};
	const double yb[]={							// 100 pts, eps=1e-5, down only
		4.188790,4.188791,4.188791,4.188793,4.188798,4.188814,4.188859,4.188986,
		4.189328,4.190189,4.192213,4.196874,4.208210,4.236983,4.307724,4.473512,
		4.852754,5.723574,7.838600,13.880005,40.362527,-1,-1,-1,
		-1,-1,-1,-1,-1,-1,-1,
		4.188790,4.188791,4.188791,4.188793,4.188798,4.188813,4.188858,4.188982,
		4.189319,4.190165,4.192156,4.196738,4.207879,4.236133,4.305531,4.467899,
		4.838139,5.683061,7.710538,13.356740,36.482501,-1,-1,-1,
		-1,-1,-1,-1,-1,-1,-1,
		4.188790,4.188791,4.188791,4.188793,4.188798,4.188812,4.188854,4.188973,
		4.189292,4.190095,4.191984,4.196332,4.206887,4.233594,4.298997,4.451212,
		4.795122,5.566006,7.352764,11.994360,28.085852,261.834153,-1,-1,
		-1,-1,-1,-1,-1,-1,-1,
		4.188790,4.188791,4.188791,4.188792,4.188797,4.188810,4.188848,4.188956,
		4.189246,4.189978,4.191699,4.195657,4.205243,4.229397,4.288214,4.424093,
		4.726265,5.384525,6.831926,10.241985,19.932261,69.581522,-1,-1,
		-1,-1,-1,-1,-1,-1,-1,
		4.188790,4.188791,4.188791,4.188792,4.188796,4.188807,4.188840,4.188933,
		4.189183,4.189814,4.191300,4.194716,4.202957,4.223593,4.273478,4.387310,
		4.635278,5.155725,6.228070,8.494834,13.840039,30.707995,217.685066,-1,
		-1,-1,-1,-1,-1,-1,-1,
		4.188790,4.188791,4.188791,4.188792,4.188795,4.188803,4.188829,4.188903,
		4.189101,4.189604,4.190789,4.193514,4.200048,4.216255,4.254956,4.342131,
		4.526936,4.897901,5.610205,6.966144,9.704274,16.182908,37.778925,387.192994,
		-1,-1,-1,-1,-1,-1,-1,
		4.188790,4.188790,4.188791,4.188791,4.188793,4.188799,4.188817,4.188866,
		4.189002,4.189348,4.190168,4.192054,4.196535,4.207468,4.233117,4.289818,
		4.406055,4.627980,5.025468,5.719284,6.973164,9.454673,15.165237,32.669841,
		175.505441,-1,-1,-1,-1,-1,-1,
		4.188790,4.188790,4.188790,4.188791,4.188791,4.188794,4.188801,4.188823,
		4.188885,4.189047,4.189439,4.190344,4.192444,4.197336,4.208277,4.231803,
		4.277545,4.359611,4.499274,4.738728,5.168746,5.973516,7.554064,10.974866,
		20.015747,59.729701,-1,-1,-1,-1,-1,
		4.188790,4.188790,4.188790,4.188790,4.188789,4.188788,4.188784,4.188774,
		4.188751,4.188701,4.188602,4.188390,4.187803,4.185972,4.180908,4.169592,
		4.145768,4.102670,4.041148,3.980771,3.961901,4.039620,4.292076,4.858676,
		6.044956,8.672140,15.704344,48.437802,-1,-1,-1,
		4.188790,4.188790,4.188790,4.188789,4.188787,4.188781,4.188764,4.188718,
		4.188599,4.188311,4.187661,4.186201,4.182644,4.173501,4.151495,4.104610,
		4.014334,3.863341,3.650600,3.398722,3.141206,2.906174,2.713737,2.580237,
		2.524103,2.574058,2.785372,3.278275,4.350631,6.897568,14.924070,
		4.188790,4.188790,4.188790,4.188788,4.188784,4.188773,4.188742,4.188656,
		4.188430,4.187878,4.186617,4.183786,4.177000,4.160053,4.120473,4.038061,
		3.886243,3.645077,3.322103,2.951900,2.573084,2.212134,1.883264,1.592189,
		1.339766,1.124235,0.942582,0.791354,0.667141,0.566827,0.487862};
	const double slo=3,sinc=-0.2;								// logs of values; shi=-3
	const double blor=0,bincr=0.2;								// logs of values; bhir=3
	const double blob=0,bincb=0.1;								// actual values; bhib=1
	const int snum=31,bnumr=16,bnumb=11;
	double x[4],y[4],z[4];
	int sindx,bindx,i,j;
	double ans;

	if(step<0 || a<0) return -1;
	if(step==0 && b>=0 && b<1) return -1;
	if(step==0) return 0;
	step=log(step/a);
	b/=a;

	sindx=(int)floor((step-slo)/sinc);
	for(i=0;i<4;i++) x[i]=slo+(sindx-1+i)*sinc;
	z[0]=(step-x[1])*(step-x[2])*(step-x[3])/(-6.0*sinc*sinc*sinc);
	z[1]=(step-x[0])*(step-x[2])*(step-x[3])/(2.0*sinc*sinc*sinc);
	z[2]=(step-x[0])*(step-x[1])*(step-x[3])/(-2.0*sinc*sinc*sinc);
	z[3]=(step-x[0])*(step-x[1])*(step-x[2])/(6.0*sinc*sinc*sinc);

	if(b<0)
		for(ans=i=0;i<4;i++) {
			if(sindx-1+i>=snum) ans+=z[i]*2.0*PI*exp(2.0*x[i]);
			else if(sindx-1+i<0) ans+=z[i]*4.0*PI/3.0;
			else ans+=z[i]*yi[sindx-1+i]; }
	else if(b<1.0) {
		bindx=(int)floor((b-blob)/bincb);
		if(bindx<1) bindx=1;
		else if(bindx+2>=bnumb) bindx=bnumb-3;
		while(sindx+3>=snum || (sindx>0 && yb[(bindx-1)*snum+sindx+3]<0)) sindx--;
		for(i=0;i<4;i++) x[i]=slo+(sindx-1+i)*sinc;
		z[0]=(step-x[1])*(step-x[2])*(step-x[3])/(-6.0*sinc*sinc*sinc);
		z[1]=(step-x[0])*(step-x[2])*(step-x[3])/(2.0*sinc*sinc*sinc);
		z[2]=(step-x[0])*(step-x[1])*(step-x[3])/(-2.0*sinc*sinc*sinc);
		z[3]=(step-x[0])*(step-x[1])*(step-x[2])/(6.0*sinc*sinc*sinc);
		for(j=0;j<4;j++)
			for(y[j]=i=0;i<4;i++) {
				if(sindx-1+i>=snum) y[j]+=z[i]*yb[(bindx-1+j)*snum];
				else if(sindx-1+i<0) y[j]+=z[i]*4.0*PI/3.0;
				else y[j]+=z[i]*yb[(bindx-1+j)*snum+sindx-1+i]; }
		for(j=0;j<4;j++) x[j]=blob+(bindx-1+j)*bincb;
		z[0]=(b-x[1])*(b-x[2])*(b-x[3])/(-6.0*bincb*bincb*bincb);
		z[1]=(b-x[0])*(b-x[2])*(b-x[3])/(2.0*bincb*bincb*bincb);
		z[2]=(b-x[0])*(b-x[1])*(b-x[3])/(-2.0*bincb*bincb*bincb);
		z[3]=(b-x[0])*(b-x[1])*(b-x[2])/(6.0*bincb*bincb*bincb);
		ans=z[0]*y[0]+z[1]*y[1]+z[2]*y[2]+z[3]*y[3]; }
	else {
		b=log(b);
		bindx=(int)floor((b-blor)/bincr);
		if(bindx<1) bindx=1;
		else if(bindx+2>=bnumr) bindx=bnumr-3;
		for(j=0;j<4;j++)
			for(y[j]=i=0;i<4;i++) {
				if(sindx-1+i>=snum && b==0) y[j]+=z[i]*2.0*PI*exp(x[i])*(1.0+exp(x[i]));
				else if(sindx-1+i>=snum) y[j]+=z[i]*2.0*PI*exp(2.0*x[i])*exp(b)/(exp(b)-1.0);
				else if(sindx-1+i<0) y[j]+=z[i]*4.0*PI/3.0;
				else y[j]+=z[i]*yr[(bindx-1+j)*snum+sindx-1+i]; }
		for(j=0;j<4;j++) x[j]=blor+(bindx-1+j)*bincr;
		z[0]=(b-x[1])*(b-x[2])*(b-x[3])/(-6.0*bincr*bincr*bincr);
		z[1]=(b-x[0])*(b-x[2])*(b-x[3])/(2.0*bincr*bincr*bincr);
		z[2]=(b-x[0])*(b-x[1])*(b-x[3])/(-2.0*bincr*bincr*bincr);
		z[3]=(b-x[0])*(b-x[1])*(b-x[2])/(6.0*bincr*bincr*bincr);
		ans=z[0]*y[0]+z[1]*y[1]+z[2]*y[2]+z[3]*y[3]; }
	return ans*a*a*a; }



/* numrxnrateprob */
double numrxnrateprob(double step,double a,double b,double prob) {
	static const double kirr[]={				// 600 pts, eps=1e-5, up&down, error<2.4%
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.012794,0.026744,0.053808,0.101319,0.171684,0.257267,0.332667,0.380164,0.403777,0.413462,0.417299,0.418443,0.418753,0.418846,0.418871,0.418877,
		0.013553,0.028900,0.060227,0.120653,0.225659,0.382063,0.561651,0.703031,0.783463,0.818408,0.831685,0.836018,0.837253,0.837626,0.837725,0.837750,
		0.013922,0.029929,0.063256,0.129889,0.253570,0.457014,0.729200,0.980644,1.141080,1.215080,1.243193,1.252729,1.255501,1.256340,1.256564,1.256619,
		0.014157,0.030578,0.065146,0.135624,0.271262,0.507901,0.857456,1.222044,1.478738,1.603867,1.651875,1.668579,1.673498,1.674987,1.675385,1.675483,
		0.014326,0.031038,0.066479,0.139666,0.283733,0.545230,0.958874,1.433702,1.797770,1.984727,2.057738,2.083569,2.091243,2.093569,2.094191,2.094344,
		0.014457,0.031389,0.067493,0.142719,0.293199,0.574088,1.041308,1.621181,2.099899,2.358197,2.461326,2.497710,2.508736,2.512085,2.512980,2.513200,
		0.014564,0.031672,0.068306,0.145143,0.300730,0.597229,1.109694,1.788092,2.386086,2.724226,2.862113,2.910998,2.925978,2.930534,2.931753,2.932052,
		0.014653,0.031908,0.068974,0.147138,0.306897,0.616388,1.167421,1.937686,2.658162,3.083297,3.260345,3.323437,3.342969,3.348918,3.350509,3.350900,
		0.014729,0.032108,0.069538,0.148832,0.312088,0.632575,1.217067,2.072722,2.916738,3.435580,3.656052,3.735031,3.759709,3.767235,3.769249,3.769744,
		0.014795,0.032281,0.070025,0.150278,0.316575,0.646483,1.260105,2.195184,3.162697,3.780914,4.049618,4.145787,4.176199,4.185487,4.187973,4.188584};
	static const double krev[]={				// 500 pts, eps=1e-5, up&down, error<2.2%
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.120758,0.170593,0.231708,0.295791,0.349717,0.385784,0.405752,0.415098,0.418145,0.418746,0.418855,0.418875,0.418879,0.418879,0.418879,0.418879,
		0.178720,0.256877,0.360764,0.486567,0.616216,0.722508,0.790295,0.823639,0.834881,0.837225,0.837660,0.837744,0.837756,0.837758,0.837758,0.837758,
		0.223775,0.323656,0.460565,0.636020,0.835736,1.022090,1.155725,1.225819,1.250218,1.255439,1.256417,1.256605,1.256633,1.256637,1.256637,1.256637,
		0.262195,0.380301,0.545042,0.762912,1.025189,1.292783,1.503790,1.621803,1.664161,1.673387,1.675125,1.675460,1.675509,1.675515,1.675516,1.675516,
		0.296354,0.430439,0.619746,0.875039,1.193979,1.540332,1.836111,2.011773,2.076719,2.091069,2.093784,2.094307,2.094384,2.094394,2.094395,2.094395,
		0.327572,0.476015,0.687509,0.976771,1.347282,1.769206,2.154125,2.395903,2.487900,2.508486,2.512395,2.513147,2.513258,2.513272,2.513274,2.513274,
		0.356552,0.518073,0.749951,1.070440,1.488779,1.982346,2.458937,2.774315,2.897709,2.925638,2.930956,2.931980,2.932132,2.932151,2.932153,2.932153,
		0.383821,0.557362,0.808184,1.157795,1.620885,2.182601,2.751757,3.147190,3.306155,3.342526,3.349469,3.350806,3.351004,3.351029,3.351032,3.351032,
		0.409695,0.594454,0.862909,1.239985,1.745135,2.371679,3.033451,3.514642,3.713243,3.759148,3.767933,3.769626,3.769876,3.769907,3.769911,3.769911,
		0.434496,0.629567,0.914735,1.317740,1.862739,2.551094,3.304861,3.876799,4.118979,4.175506,4.186348,4.188438,4.188746,4.188785,4.188790,4.188790,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.039618,0.074669,0.130765,0.206465,0.286623,0.350825,0.390458,0.409795,0.416871,0.418506,0.418808,0.418868,0.418878,0.418879,0.418879,0.418879,
		0.044646,0.088088,0.164794,0.285824,0.446047,0.610478,0.735048,0.803472,0.829890,0.836267,0.837475,0.837715,0.837753,0.837757,0.837758,0.837758,
		0.047212,0.095193,0.183660,0.333003,0.552810,0.813274,1.042052,1.182097,1.239124,1.253286,1.256000,1.256540,1.256625,1.256636,1.256637,1.256637,
		0.048880,0.099883,0.196453,0.366093,0.631994,0.978059,1.317811,1.546608,1.644637,1.669565,1.674384,1.675344,1.675494,1.675513,1.675516,1.675516,
		0.050087,0.103315,0.205988,0.391384,0.694577,1.116027,1.567360,1.897881,2.046489,2.085106,2.092626,2.094126,2.094361,2.094391,2.094395,2.094395,
		0.051019,0.106001,0.213540,0.411714,0.746131,1.234384,1.794851,2.236764,2.444743,2.499911,2.510727,2.512887,2.513225,2.513268,2.513273,2.513274,
		0.051777,0.108197,0.219735,0.428678,0.789902,1.337653,2.003240,2.563891,2.839449,2.913982,2.928687,2.931626,2.932086,2.932145,2.932152,2.932153,
		0.052408,0.110030,0.224997,0.443187,0.827910,1.429380,2.195638,2.880110,3.230677,3.327322,3.346506,3.350344,3.350945,3.351022,3.351031,3.351032,
		0.052953,0.111608,0.229537,0.455835,0.861576,1.511698,2.374586,3.186160,3.618494,3.739933,3.764184,3.769040,3.769801,3.769898,3.769910,3.769911,
		0.053423,0.112991,0.233522,0.467083,0.891698,1.586758,2.541349,3.482436,4.002933,4.151816,4.181720,4.187714,4.188654,4.188774,4.188788,4.188790,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.026265,0.052297,0.097962,0.166892,0.249582,0.324410,0.376049,0.403573,0.415040,0.418135,0.418734,0.418855,0.418876,0.418879,0.418879,0.418879,
		0.028468,0.058678,0.116102,0.215566,0.362974,0.535551,0.686235,0.780837,0.822861,0.834794,0.837177,0.837664,0.837746,0.837757,0.837758,0.837758,
		0.029534,0.061813,0.125262,0.241539,0.431026,0.686133,0.947001,1.134309,1.223664,1.249985,1.255331,1.256425,1.256609,1.256634,1.256637,1.256637,
		0.030205,0.063808,0.131160,0.258612,0.477899,0.800249,1.169829,1.466275,1.617652,1.663718,1.673195,1.675138,1.675467,1.675510,1.675515,1.675516,
		0.030686,0.065230,0.135393,0.271038,0.513004,0.890707,1.362825,1.778806,2.005028,2.076000,2.090770,2.093805,2.094318,2.094386,2.094394,2.094395,
		0.031051,0.066322,0.138667,0.280714,0.540757,0.964784,1.532011,2.073278,2.385917,2.486838,2.508056,2.512424,2.513163,2.513261,2.513273,2.513274,
		0.031343,0.067194,0.141299,0.288562,0.563502,1.027111,1.681880,2.351547,2.760539,2.896243,2.925053,2.930997,2.932002,2.932135,2.932151,2.932153,
		0.031586,0.067917,0.143475,0.295100,0.582657,1.080472,1.815756,2.614966,3.129058,3.304221,3.341761,3.349522,3.350834,3.351008,3.351029,3.351032,
		0.031792,0.068533,0.145332,0.300704,0.599198,1.127234,1.936634,2.864647,3.491616,3.710780,3.758182,3.768000,3.769661,3.769881,3.769908,3.769911,
		0.031970,0.069068,0.146950,0.305576,0.613617,1.168490,2.046277,3.101511,3.848339,4.115928,4.174315,4.186431,4.188481,4.188753,4.188786,4.188790,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.020960,0.042692,0.082444,0.145935,0.227515,0.306790,0.365023,0.397970,0.412832,0.417601,0.418623,0.418834,0.418873,0.418878,0.418879,0.418879,
		0.022397,0.046948,0.095075,0.182116,0.318688,0.490098,0.651227,0.760693,0.814517,0.832689,0.836734,0.837577,0.837733,0.837755,0.837758,0.837758,
		0.023083,0.048987,0.101223,0.200455,0.370242,0.613735,0.882130,1.092752,1.205546,1.245289,1.254335,1.256229,1.256580,1.256630,1.256636,1.256637,
		0.023509,0.050265,0.105097,0.212167,0.404515,0.703884,1.072851,1.397875,1.586355,1.655425,1.671427,1.674791,1.675415,1.675504,1.675515,1.675516,
		0.023814,0.051171,0.107845,0.220537,0.429495,0.773137,1.233258,1.679392,1.957396,2.063123,2.088009,2.093262,2.094237,2.094376,2.094393,2.094395,
		0.024042,0.051862,0.109939,0.226959,0.448846,0.828627,1.370570,1.939754,2.319006,2.468405,2.504084,2.511643,2.513047,2.513246,2.513271,2.513274,
		0.024228,0.052412,0.111618,0.232088,0.464481,0.874263,1.489521,2.181477,2.671602,2.871295,2.919652,2.929933,2.931844,2.932115,2.932149,2.932153,
		0.024378,0.052868,0.112996,0.236357,0.477529,0.912925,1.594014,2.406431,3.015510,3.271815,3.334715,3.348133,3.350629,3.350983,3.351026,3.351032,
		0.024509,0.053253,0.114175,0.239972,0.488631,0.946084,1.686510,2.616426,3.351081,3.669989,3.749272,3.766242,3.769400,3.769848,3.769904,3.769910,
		0.024619,0.053581,0.115186,0.243085,0.498245,0.975120,1.769171,2.812996,3.678641,4.065838,4.163326,4.184261,4.188160,4.188713,4.188781,4.188789,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.018162,0.037482,0.073622,0.133299,0.213273,0.294598,0.356850,0.393560,0.410623,0.416910,0.418470,0.418800,0.418867,0.418877,0.418879,0.418879,
		0.019272,0.040805,0.083687,0.163122,0.291982,0.460682,0.626861,0.745531,0.806498,0.830019,0.836126,0.837441,0.837710,0.837752,0.837757,0.837758,
		0.019798,0.042380,0.088486,0.177799,0.334922,0.568876,0.838714,1.062215,1.188581,1.239397,1.252970,1.255925,1.256529,1.256623,1.256635,1.256637,
		0.020127,0.043356,0.091484,0.187028,0.362883,0.645765,1.009848,1.348715,1.557769,1.645114,1.669004,1.674250,1.675323,1.675492,1.675513,1.675516,
		0.020359,0.044049,0.093596,0.193564,0.382961,0.703932,1.151319,1.609230,1.914517,2.047204,2.084230,2.092417,2.094094,2.094357,2.094390,2.094395,
		0.020537,0.044572,0.095203,0.198539,0.398376,0.749713,1.270503,1.847133,2.259560,2.445730,2.498652,2.510426,2.512840,2.513219,2.513267,2.513273,
		0.020676,0.044989,0.096478,0.202519,0.410736,0.787124,1.372611,2.065261,2.593486,2.840744,2.912271,2.928277,2.931562,2.932078,2.932144,2.932152,
		0.020793,0.045336,0.097529,0.205786,0.420931,0.818373,1.460963,2.266033,2.916846,3.232294,3.325091,3.345970,3.350261,3.350934,3.351020,3.351031,
		0.020893,0.045627,0.098417,0.208533,0.429584,0.845021,1.538524,2.451588,3.229875,3.620406,3.737113,3.763506,3.768935,3.769787,3.769896,3.769909,
		0.020979,0.045874,0.099184,0.210930,0.437051,0.868202,1.607365,2.623675,3.533309,4.005149,4.148339,4.180884,4.187585,4.188637,4.188772,4.188788,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.016431,0.034229,0.068022,0.125034,0.203610,0.285869,0.350542,0.389980,0.408631,0.416123,0.418278,0.418753,0.418857,0.418876,0.418879,0.418879,
		0.017391,0.037064,0.076680,0.151169,0.274654,0.440751,0.609168,0.733959,0.800201,0.827208,0.835368,0.837254,0.837671,0.837746,0.837757,0.837758,
		0.017850,0.038402,0.080770,0.163823,0.312557,0.539243,0.808364,1.039760,1.175721,1.233349,1.251276,1.255503,1.256442,1.256611,1.256634,1.256637,
		0.018138,0.039231,0.083306,0.171707,0.336867,0.608204,0.966950,1.313337,1.536275,1.634659,1.666007,1.673501,1.675169,1.675469,1.675510,1.675515,
		0.018344,0.039820,0.085089,0.177269,0.354243,0.659752,1.096479,1.559645,1.882644,2.031214,2.079567,2.091248,2.093854,2.094321,2.094386,2.094394,
		0.018501,0.040264,0.086439,0.181480,0.367465,0.700003,1.204535,1.782558,2.215560,2.423090,2.491959,2.508743,2.512494,2.513168,2.513261,2.513273,
		0.018628,0.040621,0.087515,0.184822,0.378003,0.732597,1.296298,1.985441,2.535995,2.810409,2.903191,2.925988,2.931092,2.932009,2.932135,2.932151,
		0.018734,0.040914,0.088399,0.187585,0.386660,0.759723,1.375268,2.170676,2.844582,3.193244,3.313267,3.342982,3.349646,3.350843,3.351009,3.351029,
		0.018823,0.041165,0.089146,0.189905,0.394018,0.782749,1.444048,2.340634,3.141729,3.571636,3.722192,3.759726,3.768157,3.769672,3.769882,3.769908,
		0.018900,0.041377,0.089790,0.191908,0.400303,0.802684,1.504742,2.497228,3.428310,3.945711,4.129971,4.176219,4.186625,4.188495,4.188754,4.188786,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.015315,0.032013,0.064141,0.119235,0.196707,0.279468,0.345582,0.386842,0.407092,0.415327,0.418050,0.418696,0.418843,0.418874,0.418878,0.418879,
		0.016217,0.034596,0.071975,0.143059,0.262724,0.426699,0.596125,0.724633,0.795215,0.824593,0.834513,0.837028,0.837614,0.837736,0.837755,0.837758,
		0.016652,0.035825,0.075657,0.154490,0.297433,0.518853,0.786713,1.022262,1.165754,1.227969,1.249399,1.254995,1.256314,1.256588,1.256631,1.256636,
		0.016928,0.036593,0.077940,0.161576,0.319542,0.582704,0.936890,1.286530,1.519863,1.625589,1.662721,1.672598,1.674941,1.675429,1.675505,1.675515,
		0.017126,0.037139,0.079545,0.166564,0.335228,0.630054,1.058653,1.522863,1.858407,2.017531,2.074484,2.089838,2.093497,2.094259,2.094378,2.094393,
		0.017277,0.037557,0.080767,0.170331,0.347101,0.666862,1.159496,1.735401,2.182801,2.404042,2.484706,2.506716,2.511981,2.513077,2.513249,2.513271,
		0.017401,0.037891,0.081739,0.173326,0.356561,0.696476,1.244516,1.927695,2.493610,2.785154,2.893391,2.923231,2.930393,2.931886,2.932119,2.932149,
		0.017502,0.038168,0.082544,0.175784,0.364338,0.721025,1.317425,2.102604,2.791603,3.161286,3.300570,3.339384,3.348733,3.350683,3.350987,3.351027,
		0.017590,0.038403,0.083224,0.177858,0.370871,0.741840,1.380802,2.262433,3.077767,3.532388,3.706240,3.755176,3.767002,3.769469,3.769854,3.769904,
		0.017665,0.038606,0.083803,0.179644,0.376501,0.759760,1.436259,2.408973,3.352763,3.898557,4.110411,4.170607,4.185198,4.188244,4.188720,4.188782,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.014591,0.030496,0.061305,0.114873,0.191534,0.274691,0.341774,0.383897,0.405439,0.414312,0.417732,0.418634,0.418825,0.418870,0.418878,0.418879,
		0.015455,0.032958,0.068658,0.137203,0.254106,0.416590,0.586626,0.716787,0.790596,0.821808,0.833517,0.836788,0.837544,0.837720,0.837753,0.837757,
		0.015876,0.034135,0.072125,0.147864,0.286658,0.504416,0.771159,1.008296,1.157039,1.223082,1.247436,1.254463,1.256155,1.256551,1.256625,1.256636,
		0.016142,0.034872,0.074283,0.154464,0.307303,0.564781,0.915631,1.265906,1.506017,1.618012,1.659462,1.671660,1.674659,1.675364,1.675495,1.675513,
		0.016333,0.035395,0.075805,0.159107,0.321882,0.609284,1.031946,1.495174,1.838729,2.006846,2.069624,2.088379,2.093056,2.094157,2.094362,2.094391,
		0.016481,0.035799,0.076965,0.162620,0.332941,0.643794,1.127930,1.700568,2.156433,2.389570,2.477912,2.504622,2.511346,2.512932,2.513226,2.513268,
		0.016601,0.036121,0.077887,0.165423,0.341707,0.671522,1.208555,1.885914,2.460011,2.766447,2.884360,2.920390,2.929529,2.931687,2.932088,2.932145,
		0.016701,0.036390,0.078650,0.167706,0.348922,0.694396,1.277457,2.053770,2.750453,3.137955,3.289036,3.335685,3.347605,3.350424,3.350947,3.351022,
		0.016787,0.036618,0.079302,0.169648,0.354980,0.713744,1.337052,2.206845,3.028442,3.503607,3.691856,3.750505,3.765574,3.769141,3.769804,3.769898,
		0.016861,0.036815,0.079859,0.171319,0.360194,0.730362,1.389172,2.346883,3.294920,3.863859,4.092886,4.164852,4.183437,4.187839,4.188658,4.188774,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.014074,0.029485,0.059266,0.111440,0.187292,0.270873,0.338785,0.381419,0.403542,0.413276,0.417223,0.418540,0.418807,0.418864,0.418877,0.418879,
		0.014913,0.031884,0.066373,0.132831,0.247407,0.408812,0.579465,0.710719,0.786009,0.819449,0.832265,0.836492,0.837471,0.837698,0.837748,0.837757,
		0.015316,0.033027,0.069733,0.143055,0.278509,0.493498,0.759625,0.997914,1.148809,1.218771,1.245166,1.253857,1.255992,1.256502,1.256615,1.256634,
		0.015569,0.033744,0.071824,0.149396,0.298194,0.551445,0.900006,1.250869,1.493738,1.611394,1.655938,1.670638,1.674369,1.675276,1.675478,1.675511,
		0.015748,0.034253,0.073305,0.153871,0.312115,0.594079,1.012615,1.475208,1.821706,1.997427,2.064584,2.086835,2.092604,2.094020,2.094335,2.094387,
		0.015884,0.034642,0.074435,0.157240,0.322618,0.626981,1.105124,1.675723,2.134245,2.376957,2.471101,2.502447,2.510696,2.512735,2.513188,2.513263,
		0.015991,0.034951,0.075332,0.159939,0.330991,0.653303,1.182702,1.856091,2.432468,2.750329,2.875560,2.917481,2.928645,2.931419,2.932036,2.932138,
		0.016079,0.035207,0.076074,0.162153,0.337852,0.675072,1.248761,2.019224,2.717090,3.117909,3.278044,3.331942,3.346451,3.350073,3.350879,3.351012,
		0.016156,0.035427,0.076703,0.164034,0.343602,0.693455,1.305891,2.167538,2.989238,3.479031,3.678332,3.745814,3.764115,3.768697,3.769717,3.769885,
		0.016219,0.035614,0.077244,0.165640,0.348571,0.709301,1.355666,2.302928,3.249690,3.834743,4.076708,4.159119,4.181636,4.187292,4.188550,4.188758,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.013072,0.028821,0.057877,0.108828,0.183629,0.267520,0.336401,0.379542,0.401644,0.411925,0.416290,0.418274,0.418782,0.418858,0.418875,0.418878,
		0.013852,0.031193,0.064864,0.129714,0.242072,0.402398,0.573834,0.706195,0.781841,0.816540,0.830260,0.835872,0.837389,0.837675,0.837742,0.837756,
		0.014227,0.032331,0.068181,0.139724,0.272272,0.484810,0.750832,0.990363,1.142006,1.213919,1.241877,1.252785,1.255822,1.256450,1.256601,1.256632,
		0.014459,0.033045,0.070252,0.145954,0.291400,0.541010,0.888079,1.239950,1.483811,1.604190,1.651465,1.669073,1.674081,1.675184,1.675452,1.675507,
		0.014622,0.033555,0.071725,0.150344,0.304933,0.582296,0.998030,1.460901,1.808590,1.987821,2.058805,2.084694,2.092167,2.093876,2.094295,2.094380,
		0.014743,0.033942,0.072840,0.153676,0.315177,0.614099,1.088070,1.657857,2.117492,2.364617,2.463888,2.499643,2.510078,2.512527,2.513130,2.513253,
		0.014838,0.034252,0.073735,0.156325,0.323333,0.639611,1.163458,1.834708,2.411880,2.734759,2.866749,2.913926,2.927815,2.931136,2.931957,2.932124,
		0.014916,0.034509,0.074478,0.158512,0.330021,0.660699,1.227546,1.994396,2.692766,3.098926,3.267290,3.327523,3.345378,3.349704,3.350776,3.350994,
		0.014981,0.034726,0.075098,0.160369,0.335689,0.678455,1.282880,2.139352,2.960799,3.456607,3.665870,3.740501,3.762768,3.768230,3.769587,3.769863,
		0.015035,0.034916,0.075642,0.161961,0.340532,0.693718,1.331140,2.271526,3.217046,3.808699,4.062515,4.152862,4.179987,4.186715,4.188391,4.188731,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.009412,0.028044,0.056971,0.107057,0.180669,0.264280,0.334137,0.378120,0.400345,0.410373,0.415240,0.417668,0.418679,0.418852,0.418873,0.418878,
		0.009844,0.030338,0.063875,0.127669,0.238122,0.396830,0.568939,0.702814,0.778924,0.813363,0.828151,0.834623,0.837158,0.837654,0.837735,0.837754,
		0.010036,0.031422,0.067151,0.137571,0.267867,0.477661,0.743381,0.984642,1.137267,1.209052,1.238670,1.250839,1.255433,1.256404,1.256585,1.256628,
		0.010151,0.032094,0.069190,0.143722,0.286706,0.532761,0.878427,1.231687,1.476976,1.597532,1.646932,1.666357,1.673510,1.675105,1.675423,1.675500,
		0.010229,0.032570,0.070626,0.148062,0.300067,0.573257,0.986275,1.450002,1.799495,1.978917,2.052849,2.081142,2.091385,2.093754,2.094250,2.094369,
		0.010289,0.032929,0.071722,0.151346,0.310183,0.604426,1.074622,1.644547,2.106100,2.353546,2.456511,2.495220,2.509060,2.512353,2.513065,2.513237,
		0.010336,0.033218,0.072593,0.153980,0.318220,0.629465,1.148424,1.818871,2.397819,2.721567,2.857644,2.908494,2.926523,2.930901,2.931868,2.932103,
		0.010375,0.033453,0.073318,0.156129,0.324827,0.650162,1.211088,1.976103,2.675917,3.083249,3.256838,3.321160,3.343799,3.349399,3.350660,3.350966,
		0.010407,0.033657,0.073925,0.157950,0.330427,0.667585,1.265122,2.118482,2.941301,3.438748,3.653508,3.733016,3.760863,3.767846,3.769440,3.769828,
		0.010435,0.033830,0.074453,0.159521,0.335218,0.682626,1.312350,2.248415,3.194943,3.787923,4.048242,4.144256,4.177738,4.186242,4.188208,4.188687};
	const double kb[]={							// 100 pts, eps=1e-5, down only
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.418879,0.418879,0.418879,0.418880,0.418884,0.418913,0.419069,0.420031,0.424704,0.441061,0.481388,0.576293,0.842574,2.061398,-1.000000,-1.000000,
		0.837758,0.837758,0.837758,0.837761,0.837780,0.837893,0.838520,0.842374,0.861331,0.930221,1.114734,1.598909,3.403052,-1.000000,-1.000000,-1.000000,
		1.256637,1.256637,1.256638,1.256643,1.256686,1.256941,1.258352,1.267044,1.310303,1.473806,1.951186,3.368491,11.465957,-1.000000,-1.000000,-1.000000,
		1.675516,1.675516,1.675517,1.675527,1.675602,1.676056,1.678565,1.694055,1.772063,2.080161,3.065654,6.451719,55.017679,-1.000000,-1.000000,-1.000000,
		2.094395,2.094395,2.094397,2.094413,2.094530,2.095239,2.099160,2.123421,2.247077,2.758459,4.574288,12.046333,-1.000000,-1.000000,-1.000000,-1.000000,
		2.513274,2.513275,2.513277,2.513299,2.513468,2.514489,2.520137,2.555156,2.735834,3.520731,6.664502,23.060237,-1.000000,-1.000000,-1.000000,-1.000000,
		2.932153,2.932154,2.932157,2.932187,2.932418,2.933806,2.941497,2.989276,3.238849,4.380569,9.665012,48.378142,-1.000000,-1.000000,-1.000000,-1.000000,
		3.351032,3.351033,3.351037,3.351077,3.351378,3.353192,3.363240,3.425794,3.756663,5.355836,14.192058,133.361780,-1.000000,-1.000000,-1.000000,-1.000000,
		3.769911,3.769912,3.769918,3.769968,3.770348,3.772645,3.785366,3.864725,4.289845,6.469318,21.548468,-1.000000,-1.000000,-1.000000,-1.000000,-1.000000,
		4.188790,4.188791,4.188798,4.188860,4.189330,4.192165,4.207875,4.306085,4.838997,7.750414,35.086650,-1.000000,-1.000000,-1.000000,-1.000000,-1.000000,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.418879,0.418879,0.418879,0.418880,0.418884,0.418912,0.419066,0.420010,0.424591,0.440600,0.480127,0.572920,0.829873,1.885032,-1.000000,-1.000000,
		0.837758,0.837758,0.837758,0.837761,0.837779,0.837891,0.838507,0.842290,0.860866,0.928203,1.108498,1.578962,3.275227,872.159689,-1.000000,-1.000000,
		1.256637,1.256637,1.256638,1.256643,1.256685,1.256936,1.258322,1.266855,1.309228,1.468820,1.933449,3.300476,10.495138,-1.000000,-1.000000,-1.000000,
		1.675516,1.675516,1.675517,1.675527,1.675601,1.676047,1.678512,1.693716,1.770101,2.070183,3.025564,6.260366,41.576526,-1.000000,-1.000000,-1.000000,
		2.094395,2.094395,2.094397,2.094412,2.094528,2.095224,2.099078,2.122889,2.243929,2.741492,4.492458,11.539270,-1.000000,-1.000000,-1.000000,-1.000000,
		2.513274,2.513274,2.513277,2.513299,2.513465,2.514468,2.520019,2.554386,2.731178,3.493162,6.505503,21.684186,-1.000000,-1.000000,-1.000000,-1.000000,
		2.932153,2.932154,2.932157,2.932187,2.932413,2.933779,2.941336,2.988221,3.232336,4.338605,9.358907,44.085448,-1.000000,-1.000000,-1.000000,-1.000000,
		3.351032,3.351033,3.351037,3.351076,3.351372,3.353155,3.363029,3.424409,3.747918,5.294131,13.593362,112.191645,-1.000000,-1.000000,-1.000000,-1.000000,
		3.769911,3.769912,3.769918,3.769967,3.770341,3.772598,3.785098,3.862963,4.278465,6.380749,20.310391,1180.033395,-1.000000,-1.000000,-1.000000,-1.000000,
		4.188790,4.188791,4.188798,4.188859,4.189321,4.192108,4.207545,4.303898,4.824545,7.624623,32.175152,-1.000000,-1.000000,-1.000000,-1.000000,-1.000000,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.418879,0.418879,0.418879,0.418880,0.418884,0.418910,0.419056,0.419948,0.424254,0.439236,0.476335,0.562991,0.794713,1.591032,7.234167,-1.000000,
		0.837758,0.837758,0.837758,0.837761,0.837778,0.837884,0.838467,0.842040,0.859485,0.922255,1.089919,1.521362,2.956322,13.926715,-1.000000,-1.000000,
		1.256637,1.256637,1.256638,1.256643,1.256682,1.256920,1.258233,1.266289,1.306042,1.454191,1.881915,3.108724,8.498054,-1.000000,-1.000000,-1.000000,
		1.675516,1.675516,1.675517,1.675527,1.675597,1.676019,1.678355,1.692705,1.764292,2.041612,2.910306,5.737651,24.952267,-1.000000,-1.000000,-1.000000,
		2.094395,2.094395,2.094397,2.094411,2.094521,2.095182,2.098831,2.121301,2.234617,2.691980,4.260256,10.207689,116.256139,-1.000000,-1.000000,-1.000000,
		2.513274,2.513274,2.513277,2.513298,2.513455,2.514407,2.519664,2.552088,2.717418,3.414239,6.063459,18.266487,-1.000000,-1.000000,-1.000000,-1.000000,
		2.932153,2.932154,2.932157,2.932185,2.932400,2.933695,2.940852,2.985078,3.213113,4.219091,8.531672,34.378553,-1.000000,-1.000000,-1.000000,-1.000000,
		3.351032,3.351033,3.351037,3.351074,3.351354,3.353046,3.362397,3.420282,3.722140,5.119006,12.030606,74.092130,-1.000000,-1.000000,-1.000000,-1.000000,
		3.769911,3.769912,3.769917,3.769964,3.770319,3.772460,3.784298,3.857713,4.244959,6.130732,17.235322,252.729294,-1.000000,-1.000000,-1.000000,-1.000000,
		4.188790,4.188791,4.188798,4.188855,4.189294,4.191937,4.206555,4.297383,4.782050,7.274214,25.552901,-1.000000,-1.000000,-1.000000,-1.000000,-1.000000,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.418879,0.418879,0.418879,0.418880,0.418884,0.418908,0.419040,0.419845,0.423703,0.437024,0.470123,0.547096,0.743552,1.340060,3.827105,26.985228,
		0.837758,0.837758,0.837758,0.837760,0.837776,0.837873,0.838402,0.841627,0.857231,0.912688,1.060227,1.432362,2.555187,7.519641,303.521490,-1.000000,
		1.256637,1.256637,1.256638,1.256642,1.256678,1.256895,1.258087,1.265356,1.300853,1.430861,1.800743,2.824827,6.565251,40.758821,-1.000000,-1.000000,
		1.675516,1.675516,1.675517,1.675526,1.675589,1.675974,1.678093,1.691039,1.754852,1.996136,2.733214,5.003370,15.629710,-1.000000,-1.000000,-1.000000,
		2.094395,2.094395,2.094397,2.094410,2.094510,2.095111,2.098423,2.118685,2.219520,2.614763,3.915123,8.463042,39.382971,-1.000000,-1.000000,-1.000000,
		2.513274,2.513274,2.513277,2.513295,2.513439,2.514305,2.519075,2.548304,2.695161,3.292183,5.428306,14.171948,137.238027,-1.000000,-1.000000,-1.000000,
		2.932153,2.932154,2.932157,2.932182,2.932378,2.933556,2.940050,2.979902,3.182092,4.036189,7.397832,24.263827,-1.000000,-1.000000,-1.000000,-1.000000,
		3.351032,3.351033,3.351037,3.351070,3.351325,3.352864,3.361348,3.413491,3.680642,4.855520,10.015222,44.384302,-1.000000,-1.000000,-1.000000,-1.000000,
		3.769911,3.769912,3.769917,3.769959,3.770282,3.772230,3.782969,3.849077,4.191153,5.759997,13.595420,95.945469,-1.000000,-1.000000,-1.000000,-1.000000,
		4.188790,4.188791,4.188797,4.188850,4.189248,4.191653,4.204914,4.286671,4.713983,6.763726,18.685252,396.042428,-1.000000,-1.000000,-1.000000,-1.000000,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.418879,0.418879,0.418879,0.418880,0.418883,0.418904,0.419017,0.419703,0.422954,0.434051,0.461743,0.525898,0.681822,1.113115,2.591708,8.891278,
		0.837758,0.837758,0.837758,0.837760,0.837774,0.837857,0.838311,0.841059,0.854172,0.899981,1.020926,1.319945,2.139339,5.023091,22.063827,-1.000000,
		1.256637,1.256637,1.256638,1.256642,1.256673,1.256859,1.257882,1.264071,1.293835,1.400264,1.697026,2.486600,4.956637,16.664803,-1.000000,-1.000000,
		1.675516,1.675516,1.675517,1.675524,1.675579,1.675911,1.677730,1.688745,1.742125,1.937631,2.514097,4.184735,10.280195,57.927104,-1.000000,-1.000000,
		2.094395,2.094395,2.094397,2.094408,2.094494,2.095012,2.097855,2.115086,2.199232,2.516189,3.504456,6.670052,20.714345,591.375831,-1.000000,-1.000000,
		2.513274,2.513274,2.513276,2.513293,2.513416,2.514162,2.518256,2.543099,2.665351,3.139228,4.710333,10.381776,43.455220,-1.000000,-1.000000,-1.000000,
		2.932153,2.932154,2.932156,2.932178,2.932347,2.933361,2.938935,2.972790,3.140685,3.810899,6.188551,16.146345,106.376341,-1.000000,-1.000000,-1.000000,
		3.351032,3.351033,3.351036,3.351065,3.351285,3.352610,3.359891,3.404162,3.625442,4.536344,8.019498,25.696034,512.861296,-1.000000,-1.000000,-1.000000,
		3.769911,3.769912,3.769916,3.769953,3.770231,3.771909,3.781124,3.837222,4.119835,5.320668,10.318378,43.276024,-1.000000,-1.000000,-1.000000,-1.000000,
		4.188790,4.188791,4.188796,4.188841,4.189185,4.191257,4.202634,4.271974,4.624088,6.171283,13.253166,82.956321,-1.000000,-1.000000,-1.000000,-1.000000,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.418879,0.418879,0.418879,0.418879,0.418882,0.418899,0.418988,0.419525,0.422025,0.430433,0.451507,0.500357,0.613831,0.900918,1.746570,4.681131,
		0.837758,0.837758,0.837758,0.837760,0.837771,0.837836,0.838196,0.840342,0.850400,0.884744,0.974538,1.192792,1.742243,3.383283,10.022768,46.108636,
		1.256637,1.256637,1.256637,1.256641,1.256665,1.256813,1.257622,1.262453,1.285212,1.364143,1.578596,2.129119,3.650720,9.114349,43.903189,-1.000000,
		1.675516,1.675516,1.675517,1.675523,1.675566,1.675829,1.677267,1.685860,1.726552,1.869920,2.275025,3.381987,6.792513,22.128942,474.903971,-1.000000,
		2.094395,2.094395,2.094396,2.094405,2.094473,2.094885,2.097131,2.110563,2.174511,2.403689,3.077320,5.056422,12.000524,55.124508,-1.000000,-1.000000,
		2.513274,2.513274,2.513276,2.513289,2.513387,2.513979,2.517214,2.536565,2.629182,2.967906,4.002046,7.311844,20.992441,173.871013,-1.000000,-1.000000,
		2.932153,2.932153,2.932155,2.932173,2.932307,2.933113,2.937515,2.963865,3.090661,3.563936,5.069583,10.400361,37.889335,-1.000000,-1.000000,-1.000000,
		3.351032,3.351033,3.351035,3.351058,3.351233,3.352285,3.358035,3.392467,3.559045,4.193789,6.305737,14.749223,75.146645,-1.000000,-1.000000,-1.000000,
		3.769911,3.769912,3.769915,3.769944,3.770165,3.771497,3.778774,3.822371,4.034433,4.859670,7.742638,21.132190,194.237301,-1.000000,-1.000000,-1.000000,
		4.188790,4.188791,4.188795,4.188831,4.189103,4.190748,4.199731,4.253578,4.516926,5.564549,9.421679,31.098015,15766.656021,-1.000000,-1.000000,-1.000000,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.418879,0.418879,0.418879,0.418879,0.418881,0.418892,0.418954,0.419312,0.420942,0.426304,0.439895,0.471546,0.543228,0.710657,1.144946,2.451893,
		0.837758,0.837758,0.837758,0.837759,0.837767,0.837812,0.838056,0.839489,0.846019,0.867657,0.923568,1.059763,1.383246,2.226766,4.958222,15.815698,
		1.256637,1.256637,1.256637,1.256640,1.256656,1.256758,1.257308,1.260529,1.275248,1.324360,1.454670,1.782536,2.617658,5.085270,15.178916,73.921529,
		1.675516,1.675516,1.675517,1.675521,1.675550,1.675731,1.676708,1.682430,1.708643,1.796719,2.036182,2.663748,4.399554,10.298648,43.003113,-1.000000,
		2.094395,2.094395,2.094396,2.094402,2.094449,2.094730,2.096257,2.105191,2.146221,2.285044,2.671613,3.734520,6.974164,19.955508,146.921548,-1.000000,
		2.513274,2.513274,2.513275,2.513284,2.513351,2.513757,2.515954,2.528809,2.587997,2.790204,3.365391,5.037381,10.759233,39.148606,-1.000000,-1.000000,
		2.932153,2.932153,2.932155,2.932167,2.932258,2.932810,2.935800,2.953284,3.033986,3.312768,4.122302,6.628448,16.518329,83.832582,-1.000000,-1.000000,
		3.351032,3.351032,3.351034,3.351050,3.351169,3.351890,3.355794,3.378613,3.484203,3.853412,4.947878,8.587888,25.835171,235.989039,-1.000000,-1.000000,
		3.769911,3.769912,3.769914,3.769934,3.770085,3.770997,3.775937,3.804795,3.938663,4.412014,5.848662,11.029725,42.536447,-1.000000,-1.000000,-1.000000,
		4.188790,4.188791,4.188793,4.188818,4.189004,4.190130,4.196227,4.231828,4.397381,4.989934,6.832517,14.122456,78.593940,-1.000000,-1.000000,-1.000000,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.418879,0.418879,0.418879,0.418879,0.418880,0.418885,0.418913,0.419068,0.419730,0.421810,0.427322,0.440883,0.473473,0.548679,0.731307,1.220088,
		0.837758,0.837758,0.837758,0.837759,0.837762,0.837783,0.837893,0.838511,0.841147,0.849417,0.871388,0.929587,1.074211,1.431197,2.414902,5.672603,
		1.256637,1.256637,1.256637,1.256638,1.256646,1.256692,1.256941,1.258325,1.264225,1.282715,1.332887,1.470705,1.830581,2.790586,5.824051,18.185437,
		1.675516,1.675516,1.675516,1.675518,1.675532,1.675614,1.676056,1.678507,1.688942,1.721597,1.812521,2.069537,2.779812,4.852708,12.473455,52.955031,
		2.094395,2.094395,2.094395,2.094398,2.094419,2.094549,2.095238,2.099053,2.115270,2.165953,2.310400,2.731982,3.973053,7.995945,25.701299,193.070153,
		2.513274,2.513274,2.513275,2.513279,2.513309,2.513495,2.514487,2.519959,2.543187,2.615666,2.827134,3.465378,5.481451,12.898733,54.673022,-1.000000,
		2.932153,2.932153,2.932154,2.932159,2.932201,2.932454,2.933802,2.941222,2.972665,3.070925,3.363020,4.278097,7.406858,20.926936,136.728278,-1.000000,
		3.351032,3.351032,3.351033,3.351040,3.351094,3.351425,3.353184,3.362839,3.403680,3.532286,3.919065,5.180275,9.902624,35.308227,740.257030,-1.000000,
		3.769911,3.769911,3.769912,3.769921,3.769990,3.770408,3.772632,3.784805,3.836204,3.999667,4.496424,6.183951,13.210434,65.959680,-1.000000,-1.000000,
		4.188790,4.188790,4.188792,4.188803,4.188887,4.189404,4.192146,4.207116,4.270213,4.472374,5.094797,7.303425,17.731091,163.400657,-1.000000,-1.000000,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.418879,0.418879,0.418879,0.418879,0.418879,0.418877,0.418867,0.418795,0.418419,0.417101,0.414350,0.410729,0.409159,0.417203,0.458690,0.583092,
		0.837758,0.837758,0.837758,0.837758,0.837757,0.837749,0.837708,0.837421,0.835904,0.830685,0.820612,0.811198,0.822456,0.901832,1.149019,1.857451,
		1.256637,1.256637,1.256637,1.256637,1.256634,1.256617,1.256524,1.255874,1.252435,1.240808,1.219998,1.209121,1.263345,1.498132,2.195677,4.380323,
		1.675516,1.675516,1.675516,1.675515,1.675510,1.675481,1.675315,1.674149,1.667992,1.647519,1.613600,1.610160,1.741440,2.238385,3.767246,9.194100,
		2.094395,2.094395,2.094395,2.094394,2.094386,2.094340,2.094081,2.092243,2.082553,2.050858,2.003679,2.017524,2.263751,3.161852,6.141518,18.474264,
		2.513274,2.513274,2.513274,2.513272,2.513261,2.513195,2.512820,2.510152,2.496100,2.450864,2.390700,2.433045,2.837443,4.322303,9.810202,37.566446,
		2.932153,2.932153,2.932153,2.932151,2.932135,2.932046,2.931534,2.927873,2.908611,2.847566,2.775159,2.858749,3.469315,5.795241,15.733868,84.563430,
		3.351032,3.351032,3.351032,3.351029,3.351008,3.350892,3.350221,3.345402,3.320066,3.240992,3.157885,3.295791,4.167389,7.692314,26.082685,290.714793,
		3.769911,3.769911,3.769911,3.769907,3.769881,3.769734,3.768882,3.762735,3.730447,3.632310,3.539741,3.745864,4.940481,10.187821,47.119891,-1.000000,
		4.188790,4.188790,4.188789,4.188785,4.188753,4.188571,4.187517,4.179868,4.139732,4.020915,3.920668,4.209409,5.799095,13.564035,107.996106,-1.000000,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.418879,0.418879,0.418879,0.418879,0.418877,0.418867,0.418815,0.418499,0.417036,0.412316,0.401529,0.381813,0.351446,0.316280,0.288567,0.280633,
		0.837758,0.837758,0.837758,0.837757,0.837750,0.837712,0.837502,0.836236,0.830411,0.812050,0.772842,0.710395,0.634729,0.571714,0.547882,0.582049,
		1.256637,1.256637,1.256637,1.256635,1.256620,1.256533,1.256061,1.253209,1.240159,1.199958,1.119353,1.005772,0.889900,0.815245,0.815256,0.967953,
		1.675516,1.675516,1.675516,1.675512,1.675486,1.675331,1.674491,1.669418,1.646313,1.576731,1.445145,1.276973,1.126752,1.049609,1.114988,1.464965,
		2.094395,2.094395,2.094394,2.094389,2.094348,2.094106,2.092793,2.084861,2.048908,1.942995,1.753351,1.530186,1.353514,1.294032,1.452202,2.109511,
		2.513274,2.513274,2.513273,2.513265,2.513206,2.512858,2.510966,2.499535,2.447975,2.299324,2.046602,1.774080,1.578966,1.547000,1.832649,2.953058,
		2.932153,2.932153,2.932152,2.932141,2.932061,2.931587,2.929011,2.913440,2.843546,2.646241,2.328553,2.009407,1.802002,1.809026,2.262885,4.073130,
		3.351032,3.351032,3.351030,3.351016,3.350911,3.350293,3.346927,3.326575,3.235651,2.984226,2.600191,2.237736,2.023511,2.081517,2.751576,5.596378,
		3.769911,3.769911,3.769909,3.769891,3.769758,3.768975,3.764713,3.738937,3.624323,3.313719,2.862545,2.460344,2.244492,2.365242,3.309519,7.735596,
		4.188790,4.188790,4.188787,4.188765,4.188601,4.187635,4.182371,4.150525,4.009589,3.635484,3.116719,2.678412,2.465312,2.661263,3.949894,10.889770,
		0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
		0.418879,0.418879,0.418879,0.418879,0.418875,0.418857,0.418759,0.418181,0.415610,0.407583,0.389337,0.355203,0.302742,0.239737,0.179444,0.129969,
		0.837758,0.837758,0.837758,0.837756,0.837744,0.837670,0.837276,0.834969,0.824782,0.793995,0.729543,0.625795,0.497427,0.372418,0.268999,0.190824,
		1.256637,1.256637,1.256637,1.256633,1.256605,1.256440,1.255553,1.250367,1.227659,1.161161,1.031953,0.848065,0.649270,0.474283,0.337617,0.237484,
		1.675516,1.675516,1.675515,1.675509,1.675459,1.675165,1.673588,1.664378,1.624381,1.510769,1.304522,1.039358,0.777489,0.559854,0.395113,0.276575,
		2.094395,2.094395,2.094394,2.094383,2.094306,2.093847,2.091383,2.077007,2.015082,1.844305,1.552997,1.208747,0.889847,0.634544,0.445071,0.310433,
		2.513274,2.513274,2.513272,2.513257,2.513145,2.512484,2.508937,2.488257,2.399893,2.163082,1.781627,1.360067,0.989468,0.700208,0.488457,0.339419,
		2.932153,2.932153,2.932150,2.932130,2.931978,2.931078,2.926250,2.898131,2.778940,2.468263,1.993628,1.497152,1.076088,0.754667,0.522444,0.360712,
		3.351032,3.351032,3.351028,3.351002,3.350803,3.349628,3.343321,3.306633,3.152344,2.760884,2.191914,1.626699,1.160800,0.809960,0.558793,0.384966,
		3.769911,3.769911,3.769906,3.769873,3.769621,3.768134,3.760153,3.713767,3.520222,3.041869,2.379843,1.749013,1.240638,0.862343,0.593324,0.408183,
		4.188790,4.188790,4.188784,4.188743,4.188433,4.186597,4.176743,4.119535,3.882690,3.312046,2.557935,1.864661,1.315993,0.911793,0.626124,0.430305};
	const double slo=-3,sinc=0.4,shi=3;						// logs of values; shi=3
	const double blor=0,bincr=0.3;								// logs of values; bhir=3
	const double blob=0,bincb=0.1;								// actual values; bhib=1
	const double plo=0,pinc=0.1;									// actual values; phi=1
	const int snum=16,bnumr=11,bnumb=11,pnum=11;

	int sindx,bindx,pindx,sflag;
	double logstep,steplo,stephi,problo,probhi,blo,bhi,step0,step1,logb;
	double denom,numll,numlh,numhl,numhh,kll,klh,khl,khh;
	double numlll,numllh,numlhl,numlhh,numhll,numhlh,numhhl,numhhh;
	double klll,kllh,klhl,klhh,khll,khlh,khhl,khhh;
	double lambdap,theory,ans;

	if(prob==1) return numrxnrate(step,a,b);					// reaction probability of 1 is better handled by prior function
	if(step<0 || a<0) return -1;											// rms step length and binding radius need to be >0
	if(prob<0 || prob>1) return -1;										// reaction probability cannot be outside of [0,1]
	if(prob==0) return 0;															// reaction probability of 0 has 0 reaction rate
	if(a==0) return 0;																// binding radius of 0 has 0 reaction rate
	if(step==0 && b>=0 && b<a) return -1;							// reaction rate is infinite with small steps and unbinding radius inside binding radius
	if(step==0) return 0;															// reaction rate is 0 if rms step length is 0
	// now, inputs are 0 < step < infinity, 0 < a < infinity, -infinity < b < infinity, 0 < prob < 1

	step/=a;																					// step is now reduced step length
	logstep=log(step);																// log of reduced step length
	b/=a;																							// reduced unbinding radius (or negative for irreversible)

	if(b<0 || b>=1.0) {
		sindx=(int)floor((logstep-slo)/sinc);						// find step index value, constrained by table
		if(sindx<0) {sindx=0;sflag=-1; }
		else if(sindx>snum-2) sindx=snum-2;
		else sflag=0;
		steplo=slo+sindx*sinc;													// tabulated step values low and high
		stephi=slo+(sindx+1)*sinc; }
	else {
		sindx=(int)floor((shi-logstep)/sinc);						// this table uses reversed step values
		if(sindx<0) {sindx=0;sflag=-1; }
		else if(sindx>snum-2) sindx=snum-2;
		else sflag=0;
		steplo=shi-sindx*sinc;													// tabulated step values low and high
		stephi=shi-(sindx+1)*sinc; }

	pindx=(int)floor((prob-plo)/pinc);								// find probability index value, constrained by table
	if(pindx<0) pindx=0;
	else if(pindx>pnum-2) pindx=pnum-2;
	problo=plo+pindx*pinc;														// tabulated probability values low and high
	probhi=plo+(pindx+1)*pinc;

	if(b<0) {																					// irreversible
		denom=(probhi-problo)*(stephi-steplo);
		numll=(probhi-prob)*(stephi-logstep);
		numlh=(probhi-prob)*(logstep-steplo);
		numhl=(prob-problo)*(stephi-logstep);
		numhh=(prob-problo)*(logstep-steplo);
		kll=kirr[pindx*snum+sindx];
		klh=kirr[pindx*snum+sindx+1];
		khl=kirr[(pindx+1)*snum+sindx];
		khh=kirr[(pindx+1)*snum+sindx+1];
		ans=(numll*kll+numlh*klh+numhl*khl+numhh*khh)/denom;
		if(sindx==0) {
			lambdap=sqrt(2*prob)/step;
			theory=2*PI*step*step*(1-tanh(lambdap)/lambdap);		// from Notes18C06 lambda-rho algorithm
			if(sflag==-1) ans=theory;														// use theory if step is below table
			else {																							// interpolate between theory and table if in lowest region
				step0=exp(steplo);
				step1=exp(steplo+sinc);
				ans=((step-step0)*ans+(step1-step)*theory)/(step1-step0); }}
		else if(ans>4.0*PI/3.0*prob)
			ans=4.0*PI/3.0*prob; }

	else if(b>=1.0) {																				// unbinding radius >= binding radius
		logb=log(b);
		bindx=(int)floor((logb-blor)/bincr);
		if(bindx<0) bindx=0;
		else if(bindx>bnumr-2) bindx=bnumr-2;
		blo=blor+bindx*bincr;
		bhi=blor+(bindx+1)*bincr;
		denom=(bhi-blo)*(probhi-problo)*(stephi-steplo);
		numlll=(bhi-logb)*(probhi-prob)*(stephi-logstep);
		numllh=(bhi-logb)*(probhi-prob)*(logstep-steplo);
		numlhl=(bhi-logb)*(prob-problo)*(stephi-logstep);
		numlhh=(bhi-logb)*(prob-problo)*(logstep-steplo);
		numhll=(logb-blo)*(probhi-prob)*(stephi-logstep);
		numhlh=(logb-blo)*(probhi-prob)*(logstep-steplo);
		numhhl=(logb-blo)*(prob-problo)*(stephi-logstep);
		numhhh=(logb-blo)*(prob-problo)*(logstep-steplo);
		klll=krev[bindx*snum*pnum+pindx*snum+sindx];
		kllh=krev[bindx*snum*pnum+pindx*snum+sindx+1];
		klhl=krev[bindx*snum*pnum+(pindx+1)*snum+sindx];
		klhh=krev[bindx*snum*pnum+(pindx+1)*snum+sindx+1];
		khll=krev[(bindx+1)*snum*pnum+pindx*snum+sindx];
		khlh=krev[(bindx+1)*snum*pnum+pindx*snum+sindx+1];
		khhl=krev[(bindx+1)*snum*pnum+(pindx+1)*snum+sindx];
		khhh=krev[(bindx+1)*snum*pnum+(pindx+1)*snum+sindx+1];
		ans=(numlll*klll+numllh*kllh+numlhl*klhl+numlhh*klhh+numhll*khll+numhlh*khlh+numhhl*khhl+numhhh*khhh)/denom;
		if(sindx==0) {
			lambdap=sqrt(2*prob)/step;
			if(lambdap<10) theory=2*PI*step*step*b*(lambdap*cosh(lambdap)-sinh(lambdap))/(lambdap*(b-1)*cosh(lambdap)+sinh(lambdap));
			else theory=2*PI*step*step*b*(lambdap-1)/(lambdap*(b-1)+1);
			if(sflag==-1) ans=theory;														// use theory if step is below table
			else {																							// interpolate between theory and table if in lowest region
				step0=exp(steplo);
				step1=exp(steplo+sinc);
				ans=((step-step0)*ans+(step1-step)*theory)/(step1-step0); }}
		else if(ans>4.0*PI/3.0*prob)
			ans=4.0*PI/3.0*prob; }

	else {																									// unbinding radius < binding radius
		bindx=(int)floor((b-blob)/bincb);
		if(bindx<0) bindx=0;
		else if(bindx>bnumb-2) bindx=bnumb-2;
		blo=blob+bindx*bincb;
		bhi=blob+(bindx+1)*bincb;
		while(kb[bindx*snum*pnum+(pindx+1)*snum+sindx+1]==-1) sindx--;		// avoid bad data values
		steplo=shi-sindx*sinc;													// tabulated step values low and high
		stephi=shi-(sindx+1)*sinc;
		denom=(bhi-blo)*(probhi-problo)*(stephi-steplo);
		numlll=(bhi-b)*(probhi-prob)*(stephi-logstep);
		numllh=(bhi-b)*(probhi-prob)*(logstep-steplo);
		numlhl=(bhi-b)*(prob-problo)*(stephi-logstep);
		numlhh=(bhi-b)*(prob-problo)*(logstep-steplo);
		numhll=(b-blo)*(probhi-prob)*(stephi-logstep);
		numhlh=(b-blo)*(probhi-prob)*(logstep-steplo);
		numhhl=(b-blo)*(prob-problo)*(stephi-logstep);
		numhhh=(b-blo)*(prob-problo)*(logstep-steplo);
		klll=kb[bindx*snum*pnum+pindx*snum+sindx];
		kllh=kb[bindx*snum*pnum+pindx*snum+sindx+1];
		klhl=kb[bindx*snum*pnum+(pindx+1)*snum+sindx];
		klhh=kb[bindx*snum*pnum+(pindx+1)*snum+sindx+1];
		khll=kb[(bindx+1)*snum*pnum+pindx*snum+sindx];
		khlh=kb[(bindx+1)*snum*pnum+pindx*snum+sindx+1];
		khhl=kb[(bindx+1)*snum*pnum+(pindx+1)*snum+sindx];
		khhh=kb[(bindx+1)*snum*pnum+(pindx+1)*snum+sindx+1];
		ans=(numlll*klll+numllh*kllh+numlhl*klhl+numlhh*klhh+numhll*khll+numhlh*khlh+numhhl*khhl+numhhh*khhh)/denom; }

	return ans*a*a*a; }


/* actrxnrate calculates the effective activation limited reaction rate for the
simulation, which is the reaction rate if the radial correlation function is 1
for all r>a.  The returned value needs to be divided by delta_t.  The equation
is ka=4*pi/3*[erfc(sqrt(2)/s)+s*sqrt((2/pi))]+2*sqrt(2*pi)/3*s*(s^2-1)*[exp(-2/s^2)-1].
It was calculated analytically and verified numerically. */
double actrxnrate(double step,double a,double prob) {
	double ka;

	if(step<0 || a<=0) return -1;
	if(step==0) return 0;
	step/=a;
	ka=4.0*PI/3.0*(rxnparam_erfccD(sqrt(2.0)/step)+step*sqrt(2.0/PI));
	ka+=2.0*SQRT2PI/3.0*step*(step*step-1.0)*(exp(-2.0/step/step)-1.0);
	return prob*ka*a*a*a; }


/* bindingradius returns the binding radius that corresponds to some given
information.  rate is the actual rate constant (not reduced), dt is the time
step, and difc is the mutual diffusion constant (sum of reactant diffusion
constants).  If b is -1, the reaction is assumed to be irreversible; if b>=0 and
rel=0, then the b value is used as the unbinding radius; and if b>=0 and rel=1,
then the b value is used as the ratio of the unbinding to binding radius, b/a.
This algorithm executes a simple search from numrxnrate, based on the fact that
reaction rates monotonically increase with increasing a, for all the b value
possibilities.  The return value is usually the binding radius.  However, a
value of -1 signifies illegal input parameters.
Modified 2/22/08 to allow for dt==0. */
double bindingradius(double rate,double dt,double difc,double b,int rel) {
	double a,lo,dif,step;
	int n;

	if(rate<0 || dt<0 || difc<=0) return -1;
	if(rate==0) return 0;
	if(dt==0) {
		if(b<0) return rate/(4*PI*difc);
		if(rel && b>1) return rate*(1-1/b)/(4*PI*difc);
		if(rel && b<=1) return -1;
		if(b>0) return rate/(4*PI*difc+rate/b);
		return -1; }

	step=sqrt(2.0*difc*dt);
	lo=0;
	a=step;
	while(numrxnrate(step,a,rel?b*a:b)<rate*dt) {
		lo=a;
		a*=2.0; }
	dif=a-lo;
	for(n=0;n<15;n++) {
		dif*=0.5;
		a=lo+dif;
		if(numrxnrate(step,a,rel?b*a:b)<rate*dt) lo=a; }
	a=lo+0.5*dif;
	return a; }


/* bindingradiusprob */
double bindingradiusprob(double rate,double dt,double difc,double b,int rel,double chi,double *probptr) {
	double a,step,prob,lambdap,lambda;
	double xtry[2],xmult[2],xlo[2],xhi[2],errtry,errold,chitry,ratetry;
	int it,indx;

	if(rate<0 || dt<0 || difc<=0 || chi>1) return -1;
	if(chi<0 && (!probptr || *probptr==1)) return bindingradius(rate,dt,difc,b,rel);
	if(chi<0 && probptr && *probptr==0) return 0;
	if(rate==0) {
		if(probptr && *probptr<0) *probptr=0;
		return 0; }
	// By now, rate>0, dt>=0, difc>0, b anything, rel 0 or 1, chi >=0 or *probptr in (0,1), probptr various

	if(dt==0) {
		if(chi<0) return -1;
		else if(b<0) a=rate/(4*PI*difc*chi);									// k = 4πD sigma_b chi  from general steady-state soln
		else if(rel && b>1) a=rate*(1-1/b)/(4*PI*difc*chi);
		else if(rel && b<=1) return -1;
		else if(b>0) a=rate*b/(rate+4*PI*difc*b*chi);						// k = 4πD sigma_b sigma_u chi / (sigma_u - sigma_b)  from general steady-state soln
		else return -1;
		lambdap=(3.18243*chi-3.40864*chi*chi+0.984385*chi*chi*chi)/pow(1-chi,2.08761);
		lambda=difc*lambdap/a*lambdap/a;
		if(probptr) *probptr=lambda;
		return a; }

	if(chi<0) {																							// unknown chi but known probability
		prob=*probptr;
		step=sqrt(2*difc*dt);
		xtry[0]=step;																					// binding radius is being searched
		xmult[0]=0.1;
		xlo[0]=1.0e-15;
		xhi[0]=1.0e15;
		ratetry=numrxnrateprob(step,xtry[0],rel?b*xtry[0]:b,prob);
		errtry=(ratetry/rate-1.0)*(ratetry/rate-1.0);
		for(it=0;it<100 && errtry>1.0e-6;it++) {
			errold=errtry;
//			printf("a=%g rate=%g error=%g mult=%g \n",xtry[0],ratetry,errtry,xmult[0]); //?? DEBUG CODE
			xtry[0]=xtry[0]*(1.0+xmult[0]);
			if(xtry[0]<xlo[0]) xtry[0]=xlo[0];
			else if(xtry[0]>xhi[0]) xtry[0]=xhi[0];
			ratetry=numrxnrateprob(step,xtry[0],rel?b*xtry[0]:b,prob);
			errtry=(ratetry/rate-1.0)*(ratetry/rate-1.0);
			if(errtry<errold) 																	// better so go faster in same direction
				xmult[0]*=1.1;
			else																								// worse so slow down and reverse
				xmult[0]*=-0.5; }}

	else {
		step=sqrt(2*difc*dt);
		xtry[0]=step;																					// binding radius
		xtry[1]=0.5;																					// probability
		xmult[0]=xmult[1]=0.1;
		xlo[0]=xlo[1]=1.0e-15;
		xhi[0]=1.0e15;
		xhi[1]=1.0;
		ratetry=numrxnrateprob(step,xtry[0],rel?b*xtry[0]:b,xtry[1]);
		chitry= b>=0 ? ratetry/(4*PI*difc*xtry[0]*b/(b-xtry[0])) : ratetry/(4*PI*difc*xtry[0]);
		errtry=(ratetry/rate-1.0)*(ratetry/rate-1.0)+(chitry/chi-1.0)*(chitry/chi-1.0);
		for(it=0;it<100 && errtry>1.0e-6;it++) {
			for(indx=0;indx<2;indx++) {
				errold=errtry;
				xtry[indx]=xtry[indx]*(1.0+xmult[indx]);
				if(xtry[indx]<xlo[indx]) xtry[indx]=xlo[indx];
				else if(xtry[indx]>xhi[indx]) xtry[indx]=xhi[indx];
				ratetry=numrxnrateprob(step,xtry[0],rel?b*xtry[0]:b,xtry[1]);
				chitry= b>=0 ? ratetry/(4*PI*difc*xtry[0]*b/(b-xtry[0])) : ratetry/(4*PI*difc*xtry[0]);
				errtry=(ratetry/rate-1.0)*(ratetry/rate-1.0)+(chitry/chi-1.0)*(chitry/chi-1.0);
				if(errtry<errold)												// better so go faster in same direction
					xmult[indx]*=1.1;
				else																		// worse so slow down and reverse
					xmult[indx]*=-0.5; }}}

	a=xtry[0];
	if(chi>=0) {
		prob=xtry[1];
		if(probptr) *probptr=prob; }

	return a; }


/* unbindingradius returns the unbinding radius that corresponds to the geminate
reaction probability in pgem, the time step in dt, the mutual diffusion constant
in difc, and the binding radius in a.  Illegal inputs result in a return value
of -2.  If the geminate binding probability can be made as high as that
requested, the corresponding unbinding radius is returned.  Otherwise, the
negative of the maximum achievable pgem value is returned.
Modified 2/25/08 to allow for dt==0.  */
double unbindingradius(double pgem,double dt,double difc,double a) {
	double b,lo,dif,step,ki,kmax;
	int n;

	if(pgem<=0 || pgem>=1 || difc<=0 || a<=0 || dt<0) return -2;
	if(dt==0) return a/pgem;
	step=sqrt(2.0*difc*dt);
	ki=numrxnrate(step,a,-1);
	kmax=numrxnrate(step,a,0);
	if(1.0-ki/kmax<pgem) return ki/kmax-1.0;
	lo=0;
	b=a;
	while(1.0-ki/numrxnrate(step,a,b)>pgem) {
		lo=b;
		b*=2.0; }
	dif=b-lo;
	for(n=0;n<15;n++) {
		dif*=0.5;
		b=lo+dif;
		if(1.0-ki/numrxnrate(step,a,b)>pgem) lo=b; }
	b=lo+0.5*dif;
	return b; }


/******************************************************************************/
/*************    UTILITY FUNCTION, COPIED FROM MY MATH2.C FILE    ************/
/******************************************************************************/


double rxnparam_erfccD(double x) {
	double t,z,ans;

	z=fabs(x);
	t=1.0/(1.0+0.5*z);
	ans=t*exp(-z*z-1.26551223+t*(1.00002368+t*(0.37409196+t*(0.09678418+t*(-0.18628806+t*(0.27886807+t*(-1.13520398+t*(1.48851587+t*(-0.82215223+t*0.17087277)))))))));
	return x>=0.0?ans:2.0-ans; }


/******************************************************************************/
/************    FUNCTIONS FOR INVESTIGATING AN ABSORBING SPHERE    ***********/
/******************************************************************************/


/* rdfmodelrdf. Computes analytical model rdfs. */
double rdfmodelrdf(double r,double sigmab,double sigmau,double lambdap,double gamma) {
	double g,rp,sigmaup;

	if(lambdap<0 && gamma < 0) {				// Smoluchowski model
		if(sigmau<0) {
			if(r<=sigmab) g=0;
			else g=1-sigmab/r; }
		else {
			if(r<=sigmab) g=0;
			else if(r<sigmau) g=1-sigmab/r*(sigmau-r)/(sigmau-sigmab);
			else g=1; }}
	else if(gamma>=0) {								// Collins and Kimball model
		if(sigmau<0) {
			if(r<sigmab) g=0;
			else g=1-sigmab/r*sigmab/(sigmab+gamma); }
		else {
			if(r<sigmab) g=0;
			else if(r<sigmau) g=sigmab/r*sigmab*(sigmau-r)/(sigmau*gamma+sigmab*sigmau-sigmab*sigmab);
			else g=1; }}
	else {														// Doi model
			rp=r/sigmab;
			if(sigmau<0) {
				if(rp<=1) g=sinh(rp*lambdap)/(rp*lambdap*cosh(lambdap));
				else g=1-1/rp+tanh(lambdap)/(rp*lambdap); }
			else {
				sigmaup=sigmau/sigmab;
				if(rp<=1) g=sigmaup/rp*sinh(rp*lambdap)/sinh(lambdap)/(1+lambdap*(sigmaup-1)/tanh(lambdap));
				else if(rp<sigmaup) g=sigmaup/rp*(lambdap*(rp-1)*cosh(lambdap)+sinh(lambdap))/(lambdap*(sigmaup-1)*cosh(lambdap)+sinh(lambdap));
				else g=1; }}

	return g; }


/* rdfabsorb integrates the radial diffusion function (rdf) for 0<=r<=1, sets
those values to 0, and returns the integral.  r is a vector of radii; r[0] may
equal zero but that is not required; if not, then it is assumed that the rdf has
zero slope at the origin.
   Integration uses a spherical version of the trapezoid rule: at positions r0
and r1, the function f has values f0 and f1, leading to the linear interpolation
f=[(r-r0)f1+(r1-r)f0]/(r1-r0).  Its integral is A=Integral[4*pi*r^2*f(r)*dr]
A=4*pi/(r1-r0)*[(f1-f0)/4*(r1^4-r0^4)+(r1f0-r0f1)/3*(r1^3-r0^3)]
A=pi*(f1-f0)(r1+r0)(r1^2+r0^2)+4*pi/3*(r1f0-r0f1)(r1^2+r1r0+r0^2)
The left end of the integral assumes zero slope for the rdf.  The right end does
not terminate exactly at 1, but includes the upper left triangle of the final
trapezoid.  That way, if there are two absorptions in a row, the second one will
return an integral of 0, and area is properly conserved.  The problem is that it
does not terminate exactly at 1.  Furthermore, the correct relative location of
1 between two r[j] points depends on the function.  The best solution is to use
an unevenly spaced r[j] vector, with a very narrow separation about 1 and no
r[j] equal to 1.   */
double rdfabsorb(double *r,double *rdf,int n,double bindrad,double prob) {
	int j;
	double sum,r0,r1,f0,f1;

	r0=r1=0;
	f1=rdf[0];
	sum=0;
	for(j=(r[0]==0?1:0);r1<bindrad && j<n;j++) {
		r0=r1;
		f0=f1;
		r1=r[j];
		f1=rdf[j];
		sum+=PI*(f1-f0)*(r1+r0)*(r1*r1+r0*r0)+4.0*PI/3.0*(r1*f0-r0*f1)*(r1*r1+r1*r0+r0*r0); }
	f0=0;
	sum-=PI*(f1-f0)*(r1+r0)*(r1*r1+r0*r0)+4.0*PI/3.0*(r1*f0-r0*f1)*(r1*r1+r1*r0+r0*r0);
	sum*=prob;
	for(j-=2;j>=0;j--) rdf[j]*=(1.0-prob);
	return sum; }


/* rdfdiffuse integrates the radial distribution function with the Green's
function for radially symmetric diffusion to implement diffusion over a fixed
time step.  r is a vector of radii, rdfa is the input rdf, rdfd is the output
rdf, n is the number of points, and step is the rms step length, equal to
(2Dt)^1/2.  r[0] may equal 0 but it is not required.  It is assumed that rdfa
has zero slope at r=0.  The boundary condition on the large r side is that the
function tends to 1 with a functional form 1+a2/r, for large r.  This is
accomplished by fitting the 10% largest r portion of the rdf with the function
1+a2/r.  After the integral over the tabulated data is complete, the rdf is
integrated on to infinity using the previous fit information and an analytical
result for that integral.  The numerical portion of the integral is carried out
exactly like the one in absorb but with a different integrand, which is
c(r)=Integrate[4*pi*r'^2*rdfa(r')*grn(r,r')dr'].  grn(r,r') is the Green's function, equal
to grn(r,r')=1/(4*pi*r*r')[G_step(r-r')-G_step(r+r')] and G_s(x) is a normalized
Gaussian with mean 0 and standard deviation s. */
void rdfdiffuse(double *r,double *rdfa,double *rdfd,int n,double step) {
	int i,j;
	double grn,sum,f0,f1,rr,r0,r1,alpha,beta,a2,erfcdif,erfcsum;

	alpha=beta=0;												// fit the final 10% to 1+a2/r, finding a2 value
	for(i=(int)(0.9*n);i<n;i++) {
		alpha+=1.0/r[i]/r[i];
		beta+=(rdfa[i]-1.0)/r[i]; }
	a2=beta/alpha/step;

	grn=0;
	if(r[i=0]==0) {
		rr=r1=f1=sum=0;
		for(j=1;j<n;j++) {								// loop over r' values, for r=0
			r0=r1;
			f0=f1;
			r1=r[j]/step;
			grn=exp(-r1*r1/2.0)/(2.0*PI*SQRT2PI);		// green(0,r1)
			f1=(rdfa[j]-rdfa[0])*grn;
			sum+=PI*(f1-f0)*(r1+r0)*(r1*r1+r0*r0)+4.0*PI/3.0*(r1*f0-r0*f1)*(r1*r1+r1*r0+r0*r0); }
		sum+=(1.0-rdfa[0])*(4.0*PI*r1*grn+rxnparam_erfccD(r1/sqrt(2.0)));
		rdfd[i++]=sum+rdfa[0]; }
	for(;i<n;i++) {											// loop over r values
		rr=r[i]/step;
		r1=0;
		grn=exp(-rr*rr/2.0)/(2.0*PI*SQRT2PI);	// green(rr,0)
		f1=(rdfa[0]-rdfa[i])*grn;
		sum=0;
		for(j=(r[0]==0?1:0);j<n;j++) {		// loop over r' values
			r0=r1;
			f0=f1;
			r1=r[j]/step;
			grn=1.0/rr/r1*(exp(-(rr-r1)*(rr-r1)/2.0)-exp(-(rr+r1)*(rr+r1)/2.0))/(4.0*PI*SQRT2PI);
			f1=(rdfa[j]-rdfa[i])*grn;
			sum+=PI*(f1-f0)*(r1+r0)*(r1*r1+r0*r0)+4.0*PI/3.0*(r1*f0-r0*f1)*(r1*r1+r1*r0+r0*r0); }
		erfcdif=rxnparam_erfccD((r1-rr)/sqrt(2.0));
		erfcsum=rxnparam_erfccD((r1+rr)/sqrt(2.0));
		sum+=(1.0-rdfa[i])*(4.0*PI*r1*grn+1.0/2.0*(erfcdif+erfcsum))+a2/2.0/rr*(erfcdif-erfcsum);
		rdfd[i]=sum+rdfa[i]; }
	return; }


/* Analysis of the reverse reaction involves adding a delta function to the rdf
and then convolving with the Green's function.  However, this leads to
numerical errors, although it is trivial analytically.  The function
rdfreverserxn is the analytic solution.  It adds the diffusion Green's function
to the rdf, based on a delta function at b, and after one diffusion step.  r is
a list of radii, rdf is the rdf, step is the rms step length, b is the delta
function point (which does not have to be equal or unequal to a r[j] value), and
flux is the area of the delta function. */
void rdfreverserxn(double *r,double *rdf,int n,double step,double b,double flux) {
	int i;
	double rr,k;

	k=1.0/(4.0*PI*SQRT2PI*step*step*step);		// the 4*PI*SQRT2PI are from the Green's function
	if(b==0) {
		for(i=0;i<n;i++) {
			rr=r[i]/step;
			rdf[i]+=flux*k*2.0*exp(-rr*rr/2.0); }}
	else {
		b/=step;
		if(r[i=0]==0) rdf[i++]+=flux*k*2.0*exp(-b*b/2.0);
		for(;i<n;i++) {
			rr=r[i]/step;
			rdf[i]+=flux*k/rr/b*(exp(-(rr-b)*(rr-b)/2.0)-exp(-(rr+b)*(rr+b)/2.0)); }}
	return; }


/* rdfsteadystate calculates the radial distribution function (rdf) for alternating
absorption and diffusion steps, for either irreversible or reversible reactions.
r is a vector of radii, rdfa is input as a trial rdf and output as the result
after absorption, rdfd is ignored on input but is output as the rdf after
diffusion, n is the number of elements in the vectors, step is the rms step
length, and b is either <0 if the reaction is irreversible or is the unbinding
radius if the reaction is reversible.  It executes until the fractional
difference between successive steps is less than eps, but at least 30 times and
no more than maxit times.  It can also exit if it iterates more than maxit times
before converging or if the flux exceeds maxflux; if either of these happens,
the function returns -1. */
double rdfsteadystate(double *r,double *rdfa,double *rdfd,int n,double step,double a,double b,double eps,double prob) {
	const int maxit=100000;
	const double maxflux=1e7;
	int i,it;
	double flux,fluxold;

	rdfdiffuse(r,rdfa,rdfd,n,step);
	flux=fluxold=rdfabsorb(r,rdfd,n,a,prob);
	for(it=0;it<30 || (it<maxit && flux<maxflux && fabs((flux-fluxold)/(fluxold+1e-20))>eps);it++) {
		fluxold=flux;
		rdfdiffuse(r,rdfa,rdfd,n,step);
		if(b>=0) rdfreverserxn(r,rdfd,n,step,b,flux);
		for(i=0;i<n;i++) rdfa[i]=rdfd[i];
		flux=rdfabsorb(r,rdfa,n,a,prob); }
	if(it>=maxit || flux>=maxflux) flux=-1;
	return flux; }


/* rdfmaketable is used to create data tables of reaction rates, including those
used above in numrxnrate.  All input is requested from the user using the
standard input and all output is sent to standard output.
Runtime is about 1 minute with mode i, 200 pts, eps=1e-4 */
void rdfmaketable() {
	double slo=exp(-3.0),shi=exp(3.0),sinc=exp(0.2);		// step size low, high, increment
	const double blor=exp(0.0),bhir=exp(3.0),bincr=exp(0.2);	// b value low, high, increment for b>a
	const double blob=0,bhib=1.0,bincb=0.1;					// b value low, high, increment for b<a
	double *r,*rdfa,*rdfd,dr,s,b,flux,eps;
	int i,n,done;
	char mode,dir,string[256];

	printf("Function for calculating radial diffusion functions (rdf) and reactive\n");
	printf("fluxes for alternating reaction and diffusion steps.  This module\n");
	printf("can operate in several modes.  Enter (i) for irreversible reactions\n");
	printf("(r) for reversible reactions with the unbinding radius larger than\n");
	printf("the binding radius, or (b) for other reversible reactions.  Enter this\n");
	printf("mode in upper case for machine readable output.\n");
	printf("Operation mode: ");
	scanf("%s",string);
	mode=string[0];
	printf("Enter the number of radial points in the rdf (e.g. 200): ");
	scanf("%i",&n);
	if(n<10) {
		printf("Value is too low.  Function stopped.\n");return; }
	printf("Enter level of precision (e.g. 1e-4): ");
	scanf("%lf",&eps);
	if(eps<=0) {
		printf("Impossible precision.  Function stopped.\n");return; }
	printf("Enter u for increasing step lengths, d for decreasing: ");
	scanf("%s",string);
	dir=string[0];
	if(dir=='d') {
		s=slo;slo=shi;shi=s;
		sinc=1.0/sinc; }

	r=(double*)calloc(n,sizeof(double));
	rdfa=(double*)calloc(n,sizeof(double));
	rdfd=(double*)calloc(n,sizeof(double));
	if(!r || !rdfa || !rdfd) {
		printf("Out of memory.  Function stopped.\n");return; }

	if(mode=='i' || mode=='I') b=-1;
	else if(mode=='r' || mode=='R') b=blor;
	else b=blob;
	done=0;
	if(mode=='i') printf("step     flux\n");
	else if(mode=='r' || mode=='b') printf("b      step       flux\n");
	else printf("\n");

	while(!done) {
		if(mode=='i' || mode=='I') dr=10.0/n;						// r max is set to 10 for mode i
		else if(mode=='r' || mode=='R') dr=(b+3.0)/n;		// r max is set to b+3 for mode r
		else dr=5.0/n;																// r max is set to 5 for mode b
		r[0]=0;																				// r min is set to 0
		for(i=1;r[i-1]<1 && i-1<n;i++) r[i]=r[i-1]+dr;
		r[i-1]=0.9999;																// r point below 1 is set to 0.9999
		r[i++]=1.0001;																// r point above 1 is set to 1.0001
		for(;i<n;i++) r[i]=r[i-1]+dr;

		for(i=0;i<n && r[i]<1;i++) rdfa[i]=0;
		if(dir=='u' && (mode=='i' || mode=='I'))
			for(;i<n;i++) rdfa[i]=1.0-1.0/r[i];
		else if(dir=='u' && (mode=='r' || mode=='R'))
			for(;i<n && r[i]<b;i++) rdfa[i]=1.0-(b-r[i])/r[i]/(b-1.0);
		for(;i<n;i++) rdfa[i]=1.0;

		flux=0;
		for(s=slo;slo<shi?s<shi*sqrt(sinc):s>shi*sqrt(sinc);s*=sinc) {
			if(flux>=0) flux=rdfsteadystate(r,rdfa,rdfd,n,s,1,b,eps,1);
			if(mode=='i') printf("%lf %lf\n",s,flux);
			else if(mode=='r' || mode=='b') printf("%lf %lf %lf\n",b,s,flux);
			else printf("%lf,",fabs(flux)); }
		printf("\n");

		if(mode=='i' || mode=='I') done=1;
		else if(mode=='r' || mode=='R') {
			b*=bincr;
			if(b>bhir*sqrt(bincr)) done=1; }
		else {
			b+=bincb;
			if(b>bhib+bincb/2.0) done=1; }}
	free(r);
	free(rdfa);
	free(rdfd);
	return; }


/* rdfmaketableprob is identical to rdfmaketable but also includes a reaction
probability. It also uses slightly different default parameters. */
void rdfmaketableprob() {
	double slo=exp(-3.0),shi=exp(3.0),sinc=exp(0.4);		// step size low, high, increment
	const double blor=exp(0.0),bhir=exp(3.0),bincr=exp(0.3);	// for b>=1; b value low, high, increment for b>a
	const double blob=0,bhib=1.0,bincb=0.1;					// for b<=1; b value low, high, increment for b<a
	const double plo=0,phi=1.0,pinc=0.1;						// probability low, high, increment
	double *r,*rdfa,*rdfd,dr,s,b,prob,flux,eps;
	int i,n,done,it;
	char mode,dir,string[256];

	printf("\nFunction for calculating radial diffusion functions (rdf) and reactive\n");
	printf("fluxes for alternating reaction and diffusion steps.  This module\n");
	printf("can operate in several modes.  Enter (i) for irreversible reactions\n");
	printf("(r) for reversible reactions with the unbinding radius larger than\n");
	printf("the binding radius, or (b) for reversible reactions with unbinding\n");
	printf("inside the binding radius.  Enter this mode in upper case for machine\n");
	printf("readable output.\n");
	printf("Operation mode: ");
	scanf("%s",string);
	mode=string[0];
	printf("Enter the number of radial points in the rdf (e.g. 200): ");
	scanf("%i",&n);
	if(n<10) {
		printf("Value is too low.  Function stopped.\n");return; }
	printf("Enter level of precision (e.g. 1e-4): ");
	scanf("%lf",&eps);
	if(eps<=0) {
		printf("Impossible precision.  Function stopped.\n");return; }
	if(mode=='b'||mode=='B') {
		printf("Using decreasing step lengths because in mode b or B.\n");
		dir='d'; }
	else {
		printf("Enter u for increasing step lengths, d for decreasing: ");
		scanf("%s",string);
		dir=string[0]; }
	if(dir=='d') {
		s=slo;slo=shi;shi=s;
		sinc=1.0/sinc; }
	printf("\n");

	r=(double*)calloc(n,sizeof(double));
	rdfa=(double*)calloc(n,sizeof(double));
	rdfd=(double*)calloc(n,sizeof(double));
	if(!r || !rdfa || !rdfd) {
		printf("Out of memory.  Function stopped.\n");return; }

	if(mode=='i' || mode=='I') b=-1;									// i/I mode is for irreversible.  I for machine readable.
	else if(mode=='r' || mode=='R') b=blor;						// r,R mode is for reversible with b>=1.  R for machine readable.
	else b=blob;																			// b,B mode is for reversible with b<=1.  B for machine readable.
	done=0;
	if(mode=='i') printf("iter  prob    step   flux\n");
	else if(mode=='r' || mode=='b') printf("iter  sigma_u    prob     step       flux\n");
	else {
		if(mode=='R')
			printf("b from %g to %g with steps %g\n",blor,bhir,bincr);
		else if(mode=='B')
			printf("b from %g to %g with steps %g\n",blob,bhib,bincb);
		printf("prob from %g to %g with steps %g\n",plo,phi,pinc);
		printf("step from %g to %g with steps %g\n\n",slo,shi,sinc); }

	it=0;
	while(!done) {
		if(mode=='i' || mode=='I') dr=10.0/n;						// r max is set to 10 for mode i
		else if(mode=='r' || mode=='R') dr=(b+3.0)/n;		// r max is set to b+3 for mode r
		else dr=5.0/n;																	// r max is set to 5 for mode b
		r[0]=0;																					// r min is set to 0
		for(i=1;r[i-1]<1 && i-1<n;i++) r[i]=r[i-1]+dr;
		r[i-1]=0.9999;																	// r point below 1 is set to 0.9999
		r[i++]=1.0001;																	// r point above 1 is set to 1.0001
		for(;i<n;i++) r[i]=r[i-1]+dr;

		for(prob=plo;prob<phi;prob+=pinc) {							// outside loop is b, middle loop is prob, inside loop is step

			for(i=0;i<n && r[i]<1;i++) rdfa[i]=0;
			if(dir=='u' && (mode=='i' || mode=='I'))
				for(;i<n;i++) rdfa[i]=1.0-1.0/r[i];					// use of Smoluchowski model is not ideal but I'm not sure what's better
			else if(dir=='u' && (mode=='r' || mode=='R'))
				for(;i<n && r[i]<b;i++) rdfa[i]=1.0-(b-r[i])/r[i]/(b-1.0);
			for(;i<n;i++) rdfa[i]=1.0;

			flux=0;
			for(s=slo;slo<shi?s<shi*sqrt(sinc):s>shi*sqrt(sinc);s*=sinc) {
				it++;
				if(prob==0) flux=0;
				else if(flux>=0) flux=rdfsteadystate(r,rdfa,rdfd,n,s,1,b,eps,prob);
				if(mode=='i') printf("%i %lf %lf %lf\n",it,prob,s,flux);
				else if(mode=='r' || mode=='b') printf("%i %lf %lf %lf %lf\n",it,b,prob,s,flux);
				else printf("%lf,",flux); }
			printf("\n"); }

		if(mode=='i' || mode=='I') done=1;
		else if(mode=='r' || mode=='R') {
			b*=bincr;
			if(b>bhir*sqrt(bincr)) done=1; }
		else {
			b+=bincb;
			if(b>bhib+bincb/2.0) done=1; }}
	free(r);
	free(rdfa);
	free(rdfd);
	return; }



